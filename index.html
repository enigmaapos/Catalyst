<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catalyst Protocol — DApp (Production-ready UI)</title>
  <meta name="description" content="Catalyst Protocol dApp — staking, governance, council" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small polished tweaks */
    body { background: linear-gradient(180deg,#041024 0%, #061426 100%); }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(6px); }
  </style>
</head>
<body class="min-h-screen text-white font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">Catalyst Protocol</h1>
        <p class="text-sm text-slate-300">Staking · Governance · Guardian Council</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="networkBadge" class="px-3 py-1 rounded-md text-sm glass">Network: <span id="networkName">—</span></div>
        <button id="connectBtn" class="px-4 py-2 bg-gradient-to-r from-green-500 to-cyan-400 rounded-md font-semibold text-black">Connect</button>
        <button id="disconnectBtn" class="px-4 py-2 bg-red-500 rounded-md font-semibold hidden">Disconnect</button>
      </div>
    </header><main class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- Left: Quick Status -->
  <section class="glass p-4 rounded-lg">
    <h2 class="font-semibold mb-2">Quick Status</h2>
    <div class="space-y-2 text-sm text-slate-200">
      <div>Connected: <strong id="addr">Not connected</strong></div>
      <div>CATA Balance: <strong id="cataBal">—</strong></div>
      <div>Staked NFTs (global): <strong id="globalStaked">—</strong></div>
      <div>Roles (CATA / Staking): <small id="roles">—</small></div>
    </div>

    <hr class="my-3 border-slate-700" />
    <div class="text-xs text-slate-300">Contract Addresses (fill & Save)</div>
    <div class="mt-2 space-y-2">
      <input id="addrCata" placeholder="CATA Token Address" class="w-full p-2 rounded bg-black/20 text-sm" />
      <input id="addrStaking" placeholder="Staking Contract Address" class="w-full p-2 rounded bg-black/20 text-sm" />
      <input id="addrGovernance" placeholder="Governance Contract Address" class="w-full p-2 rounded bg-black/20 text-sm" />
      <input id="addrCouncil" placeholder="GuardianCouncil Address" class="w-full p-2 rounded bg-black/20 text-sm" />
      <div class="flex gap-2">
        <button id="saveAddrs" class="px-3 py-1 bg-slate-700 rounded text-sm">Save</button>
        <button id="loadAddrs" class="px-3 py-1 bg-slate-700/50 rounded text-sm">Load from local</button>
      </div>
    </div>
  </section>

  <!-- Middle: Staking Actions -->
  <section class="glass p-4 rounded-lg">
    <h2 class="font-semibold mb-2">Staking</h2>
    <p class="text-sm text-slate-300 mb-3">Approve NFT → Term Stake or Permanent Stake → Harvest / Unstake</p>

    <div class="space-y-2 text-sm">
      <div class="grid grid-cols-2 gap-2">
        <input id="nftCollection" placeholder="NFT Collection Address" class="p-2 rounded bg-black/20" />
        <input id="nftTokenId" placeholder="Token ID" class="p-2 rounded bg-black/20" />
      </div>
      <div class="flex gap-2">
        <button id="approveNFT" class="flex-1 p-2 bg-yellow-500 text-black rounded">Approve Staking Contract</button>
        <button id="termStakeBtn" class="flex-1 p-2 bg-indigo-600 rounded">Term Stake</button>
      </div>
      <div class="flex gap-2">
        <button id="permApproveFee" class="flex-1 p-2 bg-amber-600 rounded">Approve Fee (CATA)</button>
        <button id="permStakeBtn" class="flex-1 p-2 bg-emerald-600 text-black rounded">Permanent Stake</button>
      </div>

      <div class="flex gap-2">
        <button id="harvestBtn" class="flex-1 p-2 bg-sky-600 rounded">Harvest (single token)</button>
        <button id="unstakeBtn" class="flex-1 p-2 bg-red-600 rounded">Unstake</button>
      </div>

      <div class="text-xs text-slate-400 mt-2">Batch operations available via batch forms in advanced panel.</div>
    </div>
  </section>

  <!-- Right: Governance & Council -->
  <section class="glass p-4 rounded-lg">
    <h2 class="font-semibold mb-2">Governance & Council</h2>
    <div class="text-sm text-slate-300 mb-2">Create proposal, vote, execute (governance) • Council reseed (council only)</div>

    <div class="space-y-2">
      <select id="proposalType" class="w-full p-2 rounded bg-black/20 text-sm">
        <option value="BASE_REWARD">Base Reward</option>
        <option value="HARVEST_FEE">Harvest Fee</option>
        <option value="UNSTAKE_FEE">Unstake Fee</option>
        <option value="REGISTRATION_FEE_FALLBACK">Registration Fee</option>
      </select>
      <input id="proposalValue" placeholder="New numeric value" class="w-full p-2 rounded bg-black/20 text-sm" />
      <input id="proposalCollectionCtx" placeholder="Collection address (optional)" class="w-full p-2 rounded bg-black/20 text-sm" />
      <div class="flex gap-2">
        <button id="createProposal" class="flex-1 p-2 bg-violet-600 rounded">Create Proposal</button>
        <button id="voteProposal" class="flex-1 p-2 bg-blue-600 rounded">Vote</button>
      </div>
      <input id="proposalId" placeholder="Proposal ID (hex) for voting/execution" class="w-full p-2 rounded bg-black/20 text-sm" />
      <div class="flex gap-2">
        <button id="execProposal" class="flex-1 p-2 bg-green-700 rounded">Execute (after voting)</button>
        <button id="fetchProp" class="flex-1 p-2 bg-slate-600 rounded">Fetch Proposal</button>
      </div>

      <hr class="border-slate-700 my-2" />
      <div class="text-xs text-slate-400">Council tools (guardian council addresses only)</div>
      <input id="councilBatch" placeholder="Comma-separated 7 addresses" class="w-full p-2 rounded bg-black/20 text-sm" />
      <div class="flex gap-2">
        <button id="proposeReseed" class="flex-1 p-2 bg-rose-600 rounded">Propose Reseed (active)</button>
        <button id="execReseed" class="flex-1 p-2 bg-rose-400 text-black rounded">Execute Reseed</button>
      </div>
    </div>
  </section>
</main>

<!-- Advanced / Batches -->
<section class="glass p-4 rounded-lg mt-6">
  <h2 class="font-semibold mb-2">Advanced Batch Ops</h2>
  <textarea id="batchCollections" rows="2" placeholder="Comma-separated NFT collection addresses" class="w-full p-2 rounded bg-black/20 text-sm"></textarea>
  <textarea id="batchTokenIds" rows="2" placeholder="Comma-separated token IDs" class="w-full p-2 rounded bg-black/20 text-sm"></textarea>
  <div class="flex gap-2 mt-2">
    <button id="batchTermStakeBtn" class="flex-1 p-2 bg-indigo-700 rounded">Batch Term Stake</button>
    <button id="batchPermStakeBtn" class="flex-1 p-2 bg-green-700 rounded">Batch Perm Stake</button>
  </div>
  <div class="flex gap-2 mt-2">
    <button id="batchUnstakeBtn" class="flex-1 p-2 bg-red-700 rounded">Batch Unstake</button>
  </div>
</section>

<section class="glass p-4 rounded-lg mt-6">
  <h3 class="font-semibold mb-2">Advanced / Logs</h3>
  <div id="logs" class="h-48 overflow-auto text-xs font-mono bg-black/20 p-3 rounded"></div>
</section>

<footer class="mt-6 text-xs text-slate-500">© Catalyst Protocol — Use at your own risk. This UI is provided as a convenience; double-check contract addresses and approvals before transacting.</footer>

  </div>  
  <!-- Ethers.js (bundle) -->  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>  
  <script>
    // ---------- ABI URLs (fetched dynamically instead of hardcoding) ----------
    const ABI_URLS = {
      cata: 'abi/cata.json',
      staking: 'abi/staking.json',
      governance: 'abi/governance.json',
      council: 'abi/council.json'
    };

    // ---------- App State ----------
    let provider, signer, userAddr;
    let contracts = { cata: null, staking: null, governance: null, council: null };

    // ---------- Helpers ----------
    const $ = id => document.getElementById(id);
    function log(...args) {
      console.log(...args);
      const el = $('logs');
      el.innerText = new Date().toISOString() + ' • ' + args.map(a=>typeof a==='object'?JSON.stringify(a):a).join(' ') + '\n' + el.innerText;
    }

    async function loadABI(name) {
      try {
        const res = await fetch(ABI_URLS[name]);
        return await res.json();
      } catch (e) {
        log('ABI load err', name, e);
        return [];
      }
    }

    async function connect() {
      if (!window.ethereum) return alert('No Web3 wallet detected (install MetaMask)');
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        userAddr = await signer.getAddress();
        $('addr').innerText = userAddr;
        const network = await provider.getNetwork();
        $('networkName').innerText = network.name + ' (' + network.chainId + ')';
        $('connectBtn').classList.add('hidden');
        $('disconnectBtn').classList.remove('hidden');

        // Load ABIs + attach contracts
        const [cataABI, stakingABI, govABI] = await Promise.all([
          loadABI('cata'), loadABI('staking'), loadABI('governance')
        ]);
        if ($('addrCata').value) contracts.cata = new ethers.Contract($('addrCata').value.trim(), cataABI, signer);
        if ($('addrStaking').value) contracts.staking = new ethers.Contract($('addrStaking').value.trim(), stakingABI, signer);
        if ($('addrGovernance').value) contracts.governance = new ethers.Contract($('addrGovernance').value.trim(), govABI, signer);

        if (contracts.cata) {
          const bal = await contracts.cata.balanceOf(userAddr);
          $('cataBal').innerText = ethers.utils.formatEther(bal) + ' CATA';
        }

        log('Connected', userAddr);
      } catch (e) { log('connect err', e.message || JSON.stringify(e)); }
    }

    function disconnect() {
      provider = null;
      signer = null;
      userAddr = null;
      contracts = { cata: null, staking: null, governance: null, council: null };
      $('addr').innerText = 'Not connected';
      $('cataBal').innerText = '—';
      $('networkName').innerText = '—';
      $('connectBtn').classList.remove('hidden');
      $('disconnectBtn').classList.add('hidden');
      log('Disconnected');
    }

    // ---------- Button bindings ----------
    window.addEventListener('load', ()=>{
      $('connectBtn').onclick = connect;
      $('disconnectBtn').onclick = disconnect;

      $('approveNFT').onclick = async ()=>{
        try{
          const collection = $('nftCollection').value.trim();
          const tokenId = $('nftTokenId').value.trim();
          if(!collection||!tokenId) return alert('collection & tokenId');
          const nft = new ethers.Contract(collection, await loadABI('council'), signer); // ERC721 assumed in council.json
          const stakingAddr = $('addrStaking').value.trim();
          if(!stakingAddr) return alert('set staking contract address');
          const tx = await nft.setApprovalForAll(stakingAddr, true);
          log('Approving staking contract (setApprovalForAll)', tx.hash);
          await tx.wait();
          log('Approved');
        } catch(e){ log('approveNFT err', e); }
      };

      $('termStakeBtn').onclick = async ()=>{
        try{
          const tx = await contracts.staking.termStake($('nftCollection').value.trim(), $('nftTokenId').value.trim());
          log('termStake tx', tx.hash);
          await tx.wait();
          log('Term stake complete');
        } catch(e){ log('termStake err', e); }
      };

      $('permApproveFee').onclick = async ()=>{
        try{
          if(!contracts.cata) return alert('set CATA contract address');
          const stakingAddr = $('addrStaking').value.trim();
          if(!stakingAddr) return alert('set staking contract address');
          const amt = ethers.constants.MaxUint256;
          const tx = await contracts.cata.approve(stakingAddr, amt);
          log('approve CATA tx', tx.hash);
          await tx.wait();
          log('approved CATA for staking contract');
        } catch(e){ log('permApproveFee err', e); }
      };

      $('permStakeBtn').onclick = async ()=>{
        try{
          const tx = await contracts.staking.permanentStake($('nftCollection').value.trim(), $('nftTokenId').value.trim());
          log('permanentStake tx', tx.hash);
          await tx.wait();
          log('Permanent stake complete');
        } catch(e){ log('permStake err', e); }
      };

      $('unstakeBtn').onclick = async ()=>{
        try{
          const tx = await contracts.staking.unstake($('nftCollection').value.trim(), $('nftTokenId').value.trim());
          log('unstake tx', tx.hash);
          await tx.wait();
          log('Unstaked');
        } catch(e){ log('unstake err', e); }
      };

      // Batch Ops
      $('batchTermStakeBtn').onclick = async ()=>{
        try{
          const colls = $('batchCollections').value.split(',').map(s => s.trim());
          const ids = $('batchTokenIds').value.split(',').map(s => s.trim());
          const tx = await contracts.staking.batchTermStake(colls, ids);
          log('batchTermStake tx', tx.hash);
          await tx.wait();
          log('Batch term stake complete');
        } catch(e){ log('batchTermStake err', e); }
      };

      $('batchPermStakeBtn').onclick = async ()=>{
        try{
          const colls = $('batchCollections').value.split(',').map(s => s.trim());
          const ids = $('batchTokenIds').value.split(',').map(s => s.trim());
          const tx = await contracts.staking.batchPermanentStake(colls, ids);
          log('batchPermStake tx', tx.hash);
          await tx.wait();
          log('Batch permanent stake complete');
        } catch(e){ log('batchPermStake err', e); }
      };

      $('batchUnstakeBtn').onclick = async ()=>{
        try{
          const colls = $('batchCollections').value.split(',').map(s => s.trim());
          const ids = $('batchTokenIds').value.split(',').map(s => s.trim());
          const tx = await contracts.staking.batchUnstake(colls, ids);
          log('batchUnstake tx', tx.hash);
          await tx.wait();
          log('Batch unstake complete');
        } catch(e){ log('batchUnstake err', e); }
      };

      // Governance
      $('createProposal').onclick = async ()=>{
        try{
          const mapping = { 'BASE_REWARD':0, 'HARVEST_FEE':1, 'UNSTAKE_FEE':2, 'REGISTRATION_FEE_FALLBACK':3 };
          const pType = mapping[$('proposalType').value];
          const newVal = ethers.BigNumber.from($('proposalValue').value||'0');
          const ctx = $('proposalCollectionCtx').value.trim() || ethers.constants.AddressZero;
          const tx = await contracts.governance.propose(pType, 0, newVal, ctx);
          log('propose tx', tx.hash);
          await tx.wait();
          log('Proposal created');
        } catch(e){ log('createProposal err', e); }
      };

      $('voteProposal').onclick = async ()=>{
        try{
          const id = $('proposalId').value.trim();
          const ctx = $('proposalCollectionCtx').value.trim() || ethers.constants.AddressZero
