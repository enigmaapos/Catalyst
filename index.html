<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catalyst NFT Staking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="p-6 bg-gray-800 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Catalyst NFT Staking</h1>
    <div class="flex items-center space-x-4">
      <span id="walletStatus" class="text-sm text-gray-300">Not connected</span>
      <button id="connectWallet" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded">Connect Wallet</button>
    </div>
  </header>

  <main class="p-6 space-y-8 flex-grow">

    <!-- Transparency -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Transparency</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>Total Staked NFTs: <span class="font-bold" id="totalStakedNFTs">0</span></div>
        <div>Base Reward Rate: <span class="font-bold" id="baseRewardRate">0</span></div>
        <div>Treasury Balance: <span class="font-bold" id="treasuryBalance">0</span></div>
        <div>Registered Collections: <span class="font-bold" id="topCollectionsCount">0</span></div>
      </div>
    </section>

    <!-- Single Stake -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Single Stake</h2>
      <select id="singleCollection" class="w-full p-2 text-black rounded mb-2"></select>
      <select id="singleTokenId" class="w-full p-2 text-black rounded mb-2">
        <option value="">Select Token ID</option>
      </select>
      <select id="singleMode" class="w-full p-2 text-black rounded mb-2">
        <option value="term">Term</option>
        <option value="permanent">Permanent</option>
      </select>
      <button id="singleStakeBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded w-full">Stake NFT</button>
      <div id="singleStakeStatus" class="text-sm mt-2 text-gray-300"></div>
    </section>

    <!-- Batch Stake -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Batch Stake</h2>
      <select id="batchCollection" class="w-full p-2 text-black rounded mb-2"></select>
      <select id="batchMode" class="w-full p-2 text-black rounded mb-2">
        <option value="term">Term</option>
        <option value="permanent">Permanent</option>
      </select>
      <button id="loadBatchNFTs" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded w-full">Load My NFTs</button>
      <div id="batchStakeList" class="mt-4 grid grid-cols-2 gap-2"></div>
      <button id="batchStakeBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded w-full mt-4">Stake Selected</button>
      <div id="batchStakeStatus" class="text-sm mt-2 text-gray-300"></div>
    </section>

    <!-- Collections Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Collections</h2>
      <div class="grid grid-cols-2 gap-8">
        <div>
          <h3 class="text-lg font-bold mb-2">Verified</h3>
          <input type="text" id="searchVerified" placeholder="Search verified..." class="w-full p-2 text-black rounded mb-2">
          <ul id="verifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>
        <div>
          <h3 class="text-lg font-bold mb-2">Unverified</h3>
          <input type="text" id="searchUnverified" placeholder="Search unverified..." class="w-full p-2 text-black rounded mb-2">
          <ul id="unverifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>
      </div>
    </section>

    <!-- Governance Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Governance</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-bold">Propose</h3>
          <input type="text" id="proposalTitle" placeholder="Proposal Title" class="w-full p-2 text-black rounded mb-2">
          <input type="text" id="proposalDescription" placeholder="Proposal Description" class="w-full p-2 text-black rounded mb-2">
          <input type="text" id="proposalParam" placeholder="Parameter Change" class="w-full p-2 text-black rounded mb-2">
          <button id="createProposal" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded w-full">Create Proposal</button>
        </div>
      </div>
    </section>

  </main>

  <script>
    const erc721Abi = [
      "function ownerOf(uint256 tokenId) view returns (address)",
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
      "function isApprovedForAll(address owner, address operator) view returns (bool)",
      "function setApprovalForAll(address operator, bool approved)"
    ];

    let provider, signer, userAddress, catalyst;
    let registeredCollections = [];
    let verifiedList = [], unverifiedList = [];

    const chainMap = {
      1: "mainnet",
      5: "goerli",
      137: "polygon",
      80001: "mumbai"
    };

    document.getElementById("connectWallet").addEventListener("click", init);

    async function init() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      const chainId = (await provider.getNetwork()).chainId;
      const folder = chainMap[chainId];
      if (!folder) return alert("Unsupported network");

      document.getElementById("walletStatus").innerText = `Connected: ${userAddress}`;

      const catalystData = await fetch(`contracts/${folder}/CatalystNFTStaking.json`).then(r=>r.json());
      catalyst = new ethers.Contract(catalystData.address, catalystData.abi, signer);

      loadTransparency();
      await loadCollections();
      populateCollectionDropdowns();
      hookStakeButtons();
    }

    async function loadTransparency() {
      document.getElementById("totalStakedNFTs").innerText = (await catalyst.totalStakedNFTsCount()).toString();
      document.getElementById("baseRewardRate").innerText = ethers.utils.formatEther(await catalyst.baseRewardRatePerDay());
      document.getElementById("topCollectionsCount").innerText = (await catalyst.getRegisteredCount()).toString();
    }

    async function loadCollections() {
      const addrs = await catalyst.getRegisteredCollections();
      registeredCollections = [];
      verifiedList = []; unverifiedList = [];
      for (let addr of addrs) {
        const cfg = await catalyst.getCollectionConfig(addr);
        registeredCollections.push({addr, verified: cfg.verified});
        if (cfg.verified) verifiedList.push(addr); else unverifiedList.push(addr);
      }
      renderCollectionLists();
    }

    function renderCollectionLists() {
      const v = document.getElementById("verifiedCollections");
      const u = document.getElementById("unverifiedCollections");
      v.innerHTML = ""; u.innerHTML = "";
      verifiedList.forEach(a=>{ const li=document.createElement("li"); li.innerText=a; v.appendChild(li); });
      unverifiedList.forEach(a=>{ const li=document.createElement("li"); li.innerText=a; u.appendChild(li); });
    }

    function populateCollectionDropdowns() {
      const singleSel = document.getElementById("singleCollection");
      const batchSel = document.getElementById("batchCollection");
      singleSel.innerHTML = ""; batchSel.innerHTML = "";
      registeredCollections.forEach(c=>{
        const opt1 = new Option(`${c.verified?"[V]":"[U]"} ${c.addr}`, c.addr);
        const opt2 = new Option(`${c.verified?"[V]":"[U]"} ${c.addr}`, c.addr);
        singleSel.add(opt1); batchSel.add(opt2);
      });
      singleSel.addEventListener("change", ()=>loadOwnedTokens(singleSel.value,"single"));
    }

    async function loadOwnedTokens(collection, mode) {
      const nft = new ethers.Contract(collection, erc721Abi, signer);
      const balance = await nft.balanceOf(userAddress);
      let ids = [];
      for (let i=0;i<balance;i++) {
        const tid = await nft.tokenOfOwnerByIndex(userAddress, i);
        ids.push(tid.toString());
      }
      if (mode==="single") {
        const tokenSel = document.getElementById("singleTokenId");
        tokenSel.innerHTML = "";
        ids.forEach(id => tokenSel.add(new Option(id,id)));
      } else {
        const list = document.getElementById("batchStakeList");
        list.innerHTML = "";
        ids.forEach(id=>{
          const cb = document.createElement("input"); cb.type="checkbox"; cb.value=id;
          const lbl = document.createElement("label"); lbl.className="flex items-center gap-2";
          lbl.appendChild(cb); lbl.appendChild(document.createTextNode(`Token ${id}`));
          list.appendChild(lbl);
        });
      }
    }

    function hookStakeButtons() {
      document.getElementById("singleStakeBtn").addEventListener("click", async ()=>{
        const col = document.getElementById("singleCollection").value;
        const tid = document.getElementById("singleTokenId").value;
        const mode = document.getElementById("singleMode").value;
        await approveAndStake(col, [tid], mode==="permanent");
        document.getElementById("singleStakeStatus").innerText = `Staked token ${tid}`;
      });

      document.getElementById("loadBatchNFTs").addEventListener("click", async ()=>{
        await loadOwnedTokens(document.getElementById("batchCollection").value, "batch");
      });

      document.getElementById("batchStakeBtn").addEventListener("click", async ()=>{
        const col = document.getElementById("batchCollection").value;
        const mode = document.getElementById("batchMode").value;
        const ids = Array.from(document.querySelectorAll("#batchStakeList input:checked")).map(cb=>cb.value);
        await approveAndStake(col, ids, mode==="permanent");
        document.getElementById("batchStakeStatus").innerText = `Batch staked ${ids.length} NFTs`;
      });
    }

    async function approveAndStake(collection, tokenIds, permanent) {
      const nft = new ethers.Contract(collection, erc721Abi, signer);
      if (!(await nft.isApprovedForAll(userAddress, catalyst.address))) {
        const txa = await nft.setApprovalForAll(catalyst.address, true);
        await txa.wait();
      }
      if (tokenIds.length===1) {
        const tx = permanent? await catalyst.permanentStake(collection, tokenIds[0]) : await catalyst.termStake(collection, tokenIds[0]);
        await tx.wait();
      } else {
        const tx = permanent? await catalyst.permanentStakeBatch(collection, tokenIds) : await catalyst.termStakeBatch(collection, tokenIds);
        await tx.wait();
      }
    }
  </script>
</body>
</html>
