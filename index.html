<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚öóÔ∏è Catalyst DApp ‚Äì Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    :root { --bg:#0f1220; --card:#171a2b; --muted:#9aa3b2; --text:#e7ecf4; --acc:#6ee7ff; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text); }
    header { padding:14px 20px; border-bottom:1px solid #20243a; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0; opacity:.95; }
    input, select, button { background:#0c0f1c; color:var(--text); border:1px solid #27304a; border-radius:10px; padding:8px 10px; }
    button { cursor:pointer; font-weight:600; }
    button.primary { background:#132a39; border-color:#1e3a53; }
    main { max-width:1200px; margin:20px auto; padding:0 16px 60px; }
    .grid { display:grid; gap:16px; grid-template-columns:repeat(12,1fr); }
    .card { grid-column:span 12; background:var(--card); border:1px solid #232744; border-radius:16px; padding:16px; }
    @media(min-width:900px){ .span6 { grid-column:span 6; } }
    .tabbar { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
    .tabbar button { background:transparent; border:1px solid #27304a; }
    .tabbar button.active { background:#132a39; border-color:#1e3a53; }
    .tab { display:none; }
    .tab.active { display:block; }
    .row { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .hr { height:1px; background:#232744; margin:14px 0; }
    .mono { font-family: monospace; font-size:13px; }
  </style>
</head>
<body>
<header>
  <h1>‚öóÔ∏è Catalyst DApp</h1>
  <input id="contractAddress" placeholder="0x‚Ä¶ CatalystNFTStakingUpgradeable" style="min-width:320px">
  <button id="saveContractBtn" class="primary">Save</button>
  <button id="connectBtn" class="primary">Connect Wallet</button>
  <span id="acct" class="mono">Not connected</span>
</header>

<main>
  <div class="grid">
    <section class="card span6">
      <div class="tabbar">
        <button data-tab="stake" class="active">Stake</button>
        <button data-tab="bluechip">Blue-Chip</button>
        <button data-tab="governance">Governance</button>
        <button data-tab="guardians">Guardians</button>
        <button data-tab="admin">Admin</button>
      </div>

      <!-- Stake Tab -->
      <div id="tab-stake" class="tab active">
        <h3>Stake / Unstake</h3>
        <input id="colStake" placeholder="Collection (0x‚Ä¶)" />
        <input id="tidStake" type="number" placeholder="Token ID" />
        <button id="btnStake" class="primary">Stake</button>
        <button id="btnHarvest">Harvest</button>
        <button id="btnUnstake">Unstake</button>
      </div>

      <!-- Bluechip Tab -->
      <div id="tab-bluechip" class="tab">
        <h3>Blue-Chip</h3>
        <button id="btnEnrollBlue" class="primary">Enroll Blue-Chip</button><br><br>
        <input id="colBlueHarvest" placeholder="Collection (0x‚Ä¶)" />
        <button id="btnHarvestBlue">Harvest Blue-Chip</button>
      </div>

      <!-- Governance Tab -->
      <div id="tab-governance" class="tab">
        <h3>Governance</h3>
        <input id="propId" placeholder="Proposal ID (bytes32)" />
        <button id="btnVote">Vote</button>
        <button id="btnExecute">Execute</button>
      </div>

      <!-- Guardians Tab -->
      <div id="tab-guardians" class="tab">
        <h3>Guardians (7:5)</h3>
        <input id="newDeployer" placeholder="New Deployer Address" />
        <button id="btnPropDep">Propose</button>
        <button id="btnApproveDep">Approve</button>
        <button id="btnExecDep">Execute</button>
      </div>

      <!-- Admin Tab -->
      <div id="tab-admin" class="tab">
        <h3>Admin Controls</h3>
        <button id="btnPause">Pause</button>
        <button id="btnUnpause">Unpause</button><br><br>
        <input id="toTreasury" placeholder="Withdraw To (0x‚Ä¶)" />
        <input id="amtTreasury" type="number" placeholder="Amount (wei)" />
        <button id="btnWithdraw">Withdraw Treasury</button>
      </div>
    </section>

    <!-- Stats + Console -->
    <section class="card span6">
      <h3>üìä Protocol Stats</h3>
      <button id="btnRefresh" class="primary">Refresh</button>
      <pre id="stats" class="mono">‚Äî</pre>
      <div class="hr"></div>
      <h3>Console</h3>
      <div id="log" class="mono" style="white-space:pre-wrap; min-height:180px"></div>
    </section>
  </div>
</main>

<script type="module">
import ABI from "../abi/CatalystNFTStakingUpgradeable.json" assert { type: "json" };

let provider, signer, user, contractRead, contractWrite;

const $ = id => document.getElementById(id);
const log = msg => { $("log").textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + $("log").textContent; };

function saveContractAddress(addr){
  localStorage.setItem("catalyst_contract", addr);
  $("contractAddress").value = addr;
}
function getContractAddress(){ return $("contractAddress").value.trim(); }

async function connect() {
  if (!window.ethereum) return log("No wallet found");
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  user = await signer.getAddress();
  $("acct").textContent = user;

  const addr = getContractAddress();
  contractRead  = new ethers.Contract(addr, ABI, provider);
  contractWrite = new ethers.Contract(addr, ABI, signer);

  log("Connected " + user);
  await refreshStats();
}

// Tabs
document.querySelectorAll(".tabbar button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabbar button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
  };
});

// ---- Stake
$("btnStake").onclick = async ()=>{
  const col=$("colStake").value; const id=BigInt($("tidStake").value||"0");
  const tx=await contractWrite.stake(col,id,true);
  await tx.wait(); log("Staked ‚úÖ"); refreshStats();
};
$("btnUnstake").onclick = async ()=>{
  const col=$("colStake").value; const id=BigInt($("tidStake").value||"0");
  const tx=await contractWrite.unstake(col,id);
  await tx.wait(); log("Unstaked ‚úÖ"); refreshStats();
};
$("btnHarvest").onclick = async ()=>{
  const col=$("colStake").value; const id=BigInt($("tidStake").value||"0");
  const tx=await contractWrite.harvest(col,id);
  await tx.wait(); log("Harvested ‚úÖ");
};

// ---- Bluechip
$("btnEnrollBlue").onclick = async ()=>{ const tx=await contractWrite.enrollBluechip(); await tx.wait(); log("Bluechip enrolled ‚úÖ"); };
$("btnHarvestBlue").onclick = async ()=>{
  const col=$("colBlueHarvest").value;
  const tx=await contractWrite.harvestBluechip(col); await tx.wait(); log("Bluechip harvested ‚úÖ");
};

// ---- Governance
$("btnVote").onclick = async ()=>{ const id=$("propId").value; const tx=await contractWrite.vote(id); await tx.wait(); log("Voted ‚úÖ"); };
$("btnExecute").onclick = async ()=>{ const id=$("propId").value; const tx=await contractWrite.executeProposal(id); await tx.wait(); log("Proposal executed ‚úÖ"); };

// ---- Guardians
$("btnPropDep").onclick = async ()=>{ const a=$("newDeployer").value; const tx=await contractWrite.proposeDeployerRecovery(a); await tx.wait(); log("Proposed ‚úÖ"); };
$("btnApproveDep").onclick = async ()=>{ const tx=await contractWrite.approveDeployerRecovery(); await tx.wait(); log("Approved ‚úÖ"); };
$("btnExecDep").onclick = async ()=>{ const tx=await contractWrite.executeDeployerRecovery(); await tx.wait(); log("Executed ‚úÖ"); };

// ---- Admin
$("btnPause").onclick = async ()=>{ const tx=await contractWrite.pause(); await tx.wait(); log("Paused ‚úÖ"); };
$("btnUnpause").onclick = async ()=>{ const tx=await contractWrite.unpause(); await tx.wait(); log("Unpaused ‚úÖ"); };
$("btnWithdraw").onclick = async ()=>{
  const to=$("toTreasury").value; const amt=BigInt($("amtTreasury").value||"0");
  const tx=await contractWrite.withdrawTreasury(to,amt); await tx.wait(); log("Withdrawn ‚úÖ"); refreshStats();
};

// ---- Stats
async function refreshStats(){
  if(!contractRead) return;
  const s=await contractRead.stakingStats();
  const treasury=await contractRead.treasuryBalance();
  $("stats").textContent=`
totalAll:        ${s.totalAll}
totalTerm:       ${s.totalTerm}
totalPermanent:  ${s.totalPermanent}
remainingGlobal: ${s.remainingGlobal}
remainingTerm:   ${s.remainingTerm}
remainingPerm:   ${s.remainingPermanent}
treasuryBalance: ${treasury}
  `.trim();
}

// Events
$("connectBtn").onclick=connect;
$("saveContractBtn").onclick=()=>saveContractAddress(getContractAddress());
$("btnRefresh").onclick=refreshStats;

// Auto-load saved address
window.addEventListener("load",()=>{ $("contractAddress").value=localStorage.getItem("catalyst_contract")||""; log("Ready. Connect wallet."); });
</script>
</body>
</html>
