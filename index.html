
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalyst NFT Staking DApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white">

  <!-- Header -->
  <header class="p-6 bg-gray-800 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Catalyst NFT Staking</h1>
    <button id="connectWallet" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded">Connect Wallet</button>
  </header>

  <main class="p-6 space-y-8">

    <!-- Transparency -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Transparency</h2>
      <div id="transparencyData" class="grid grid-cols-2 gap-4 text-sm">
        <div>Total Staked NFTs: <span class="font-bold" id="totalStakedNFTs">0</span></div>
        <div>Base Reward Rate: <span class="font-bold" id="baseRewardRate">0</span></div>
        <div>Treasury Balance: <span class="font-bold" id="treasuryBalance">0</span></div>
        <div>Top Collections Count: <span class="font-bold" id="topCollectionsCount">0</span></div>
      </div>
    </section>

    <!-- Collection Registration -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Collection Registration</h2>
      <input type="text" id="collectionAddress" placeholder="Collection Address" class="w-full p-2 text-black rounded mb-2">
      <input type="number" id="declaredSupply" placeholder="Declared Max Supply" class="w-full p-2 text-black rounded mb-2">
      <select id="collectionTier" class="w-full p-2 text-black rounded mb-2">
        <option value="0">Unverified</option>
        <option value="1">Verified</option>
      </select>
      <button id="registerCollection" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded w-full">Register Collection</button>
    </section>

    <!-- Key User Functions -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Key User Functions</h2>
      <div class="grid grid-cols-2 gap-4">
        <button id="stakeTerm" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Stake (Term)</button>
        <button id="stakePermanent" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">Stake (Permanent)</button>
        <button id="batchStake" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded">Batch Stake</button>
        <button id="batchUnstake" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Batch Unstake</button>
        <button id="harvestRewards" class="bg-teal-500 hover:bg-teal-600 px-4 py-2 rounded">Harvest Rewards</button>
      </div>
    </section>

    <!-- Collections Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Collections</h2>
      <div class="grid grid-cols-2 gap-8">
        <div>
          <h3 class="text-lg font-bold">Verified Collections</h3>
          <ul id="verifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>
        <div>
          <h3 class="text-lg font-bold">Unverified Collections</h3>
          <ul id="unverifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>
      </div>
    </section>

    <!-- Governance Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Governance</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-bold">Propose</h3>
          <select id="proposalType" class="w-full p-2 text-black rounded mb-2">
            <option value="0">Base Reward</option>
            <option value="1">Harvest Fee</option>
            <option value="2">Unstake Fee</option>
            <option value="3">Registration Fee</option>
            <option value="4">Treasury Split</option>
            <option value="5">Voting Param</option>
            <option value="6">Tier Upgrade</option>
          </select>
          <input type="number" id="newValue" placeholder="New Value" class="w-full p-2 text-black rounded mb-2">
          <input type="text" id="collectionContext" placeholder="Collection Address (if applicable)" class="w-full p-2 text-black rounded mb-2">
          <button id="createProposal" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded w-full">Create Proposal</button>
        </div>
        <div>
          <h3 class="font-bold">Vote</h3>
          <input type="text" id="proposalIdVote" placeholder="Proposal ID" class="w-full p-2 text-black rounded mb-2">
          <button id="voteProposal" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded w-full">Vote</button>
        </div>
        <div>
          <h3 class="font-bold">Execute</h3>
          <input type="text" id="proposalIdExecute" placeholder="Proposal ID" class="w-full p-2 text-black rounded mb-2">
          <button id="executeProposal" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded w-full">Execute</button>
        </div>
      </div>
    </section>

  </main>

  <script>
    const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS";
    const ABI = []; // Paste your CatalystNFTStaking ABI here
    const CONTRACT_ADMIN_ROLE = ethers.utils.id("CONTRACT_ADMIN_ROLE");

    let provider, signer, contract, userAddress;

    document.getElementById("connectWallet").addEventListener("click", async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        alert(`Wallet Connected: ${userAddress}`);
        setupTierLocking();
      } else {
        alert("MetaMask not found");
      }
    });

    async function setupTierLocking() {
      const tierSelect = document.getElementById("collectionTier");
      const collectionAddressInput = document.getElementById("collectionAddress");

      async function isAdmin() {
        try {
          return await contract.hasRole(CONTRACT_ADMIN_ROLE, userAddress);
        } catch {
          return false;
        }
      }

      async function isCollectionOwner(collectionAddress) {
        if (!ethers.utils.isAddress(collectionAddress)) return false;
        const nft = new ethers.Contract(
          collectionAddress,
          [
            "function ownerOf(uint256 tokenId) public view returns (address)",
            "function owner() public view returns (address)"
          ],
          provider
        );
        try {
          const owner0 = await nft.ownerOf(0);
          if (owner0.toLowerCase() === userAddress.toLowerCase()) return true;
        } catch {}
        try {
          const contractOwner = await nft.owner();
          if (contractOwner.toLowerCase() === userAddress.toLowerCase()) return true;
        } catch {}
        return false;
      }

      collectionAddressInput.addEventListener("input", async () => {
        const collectionAddr = collectionAddressInput.value.trim();
        const admin = await isAdmin();
        const owner = await isCollectionOwner(collectionAddr);
        if (admin || owner) {
          tierSelect.disabled = false;
        } else {
          tierSelect.value = "0"; // Force Unverified
          tierSelect.disabled = true;
        }
      });
    }

    document.getElementById("registerCollection").addEventListener("click", async () => {
      const collectionAddress = document.getElementById("collectionAddress").value.trim();
      const declaredSupply = document.getElementById("declaredSupply").value;
      const tier = document.getElementById("collectionTier").value;
      try {
        const tx = await contract.setCollectionConfig(collectionAddress, declaredSupply, tier);
        await tx.wait();
        alert("Collection Registered!");
      } catch (err) {
        console.error(err);
        alert("Registration failed");
      }
    });
  </script>

</body>
</html>
