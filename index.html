<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalyst NFT Staking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="p-6 bg-gray-800 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Catalyst NFT Staking</h1>
    <div class="flex items-center space-x-4">
      <span id="walletStatus" class="text-sm text-gray-300">Not connected</span>
      <button id="connectWallet" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded">Connect Wallet</button>
    </div>
  </header>

  <main class="p-6 space-y-8 flex-grow">

    <!-- Transparency -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Transparency</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>Total Staked NFTs: <span class="font-bold" id="totalStakedNFTs">0</span></div>
        <div>Base Reward Rate: <span class="font-bold" id="baseRewardRate">0</span></div>
        <div>Treasury Balance: <span class="font-bold" id="treasuryBalance">0</span></div>
        <div>Top Collections Count: <span class="font-bold" id="topCollectionsCount">0</span></div>
      </div>
    </section>

    <!-- Collection Registration -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Register Collection</h2>
      <input type="text" id="collectionAddress" placeholder="Collection Address" class="w-full p-2 text-black rounded mb-2">
      <input type="number" id="declaredSupply" placeholder="Declared Max Supply" class="w-full p-2 text-black rounded mb-2">
      <select id="collectionTier" class="w-full p-2 text-black rounded mb-2">
        <option value="0">Unverified</option>
        <option value="1">Verified</option>
      </select>
      <button id="registerCollection" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded w-full">Register Collection</button>
    </section>

    <!-- Key User Functions -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Key User Functions</h2>
      <div class="grid grid-cols-2 gap-4">
        <button id="stakeTerm" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Stake (Term)</button>
        <button id="stakePermanent" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">Stake (Permanent)</button>
        <button id="batchStake" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded">Batch Stake</button>
        <button id="batchUnstake" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Batch Unstake</button>
        <button id="harvestRewards" class="bg-teal-500 hover:bg-teal-600 px-4 py-2 rounded">Harvest Rewards</button>
      </div>
    </section>

    <!-- Collections Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Collections</h2>
      <div class="grid grid-cols-2 gap-8">

        <!-- Verified -->
        <div>
          <h3 class="text-lg font-bold mb-2">Verified Collections</h3>
          <input type="text" id="searchVerified" placeholder="Search verified..." class="w-full p-2 text-black rounded mb-2">
          <ul id="verifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>

        <!-- Unverified -->
        <div>
          <h3 class="text-lg font-bold mb-2">Unverified Collections</h3>
          <input type="text" id="searchUnverified" placeholder="Search unverified..." class="w-full p-2 text-black rounded mb-2">
          <ul id="unverifiedCollections" class="list-disc list-inside space-y-1"></ul>
        </div>

      </div>
    </section>

    <!-- Governance Section -->
    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Governance</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-bold">Propose</h3>
          <input type="text" id="proposalTitle" placeholder="Proposal Title" class="w-full p-2 text-black rounded mb-2">
          <input type="text" id="proposalDescription" placeholder="Proposal Description" class="w-full p-2 text-black rounded mb-2">
          <input type="text" id="proposalParam" placeholder="Parameter Change" class="w-full p-2 text-black rounded mb-2">
          <button id="createProposal" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded w-full">Create Proposal</button>
        </div>
        <div>
          <h3 class="font-bold">Vote</h3>
          <input type="number" id="proposalIdVote" placeholder="Proposal ID" class="w-full p-2 text-black rounded mb-2">
          <button id="voteProposal" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded w-full">Vote</button>
        </div>
        <div>
          <h3 class="font-bold">Execute</h3>
          <input type="number" id="proposalIdExecute" placeholder="Proposal ID" class="w-full p-2 text-black rounded mb-2">
          <button id="executeProposal" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded w-full">Execute</button>
        </div>
      </div>
    </section>

  </main>

  <script>
    let provider, signer, cata, catalyst;
    let verifiedList = [], unverifiedList = [];

    const erc721Abi = [
      "function ownerOf(uint256 tokenId) view returns (address)",
      "function getApproved(uint256 tokenId) view returns (address)",
      "function isApprovedForAll(address owner, address operator) view returns (bool)",
      "function approve(address to, uint256 tokenId)",
      "function setApprovalForAll(address operator, bool approved)"
    ];

    const chainMap = {
      1: "mainnet",
      5: "goerli",
      137: "polygon",
      80001: "mumbai"
    };

    document.getElementById("connectWallet").addEventListener("click", init);
    document.getElementById("searchVerified").addEventListener("input", renderCollections);
    document.getElementById("searchUnverified").addEventListener("input", renderCollections);

    async function init() {
      if (!window.ethereum) return alert("MetaMask not detected");
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();

      const chainId = (await provider.getNetwork()).chainId;
      const folder = chainMap[chainId];
      if (!folder) {
        document.getElementById("walletStatus").innerText = `Network ${chainId} not supported`;
        return;
      }

      document.getElementById("walletStatus").innerText =
        `Connected: ${await signer.getAddress()} (Chain: ${folder})`;

      const cataData = await fetch(`contracts/${folder}/CATA.json`).then(res => res.json());
      const catalystData = await fetch(`contracts/${folder}/CatalystNFTStaking.json`).then(res => res.json());

      cata = new ethers.Contract(cataData.address, cataData.abi, signer);
      catalyst = new ethers.Contract(catalystData.address, catalystData.abi, signer);

      loadTransparency();
      loadCollections();
      hookButtons();
    }

    async function loadTransparency() {
      const totalStaked = await catalyst.totalStakedNFTsCount();
      const rewardRate = await catalyst.baseRewardRatePerDay();
      const treasuryAddr = await catalyst.treasuryAddress();
      const treasuryBal = await cata.balanceOf(treasuryAddr);
      const collections = await catalyst.getRegisteredCount();

      document.getElementById("totalStakedNFTs").innerText = totalStaked.toString();
      document.getElementById("baseRewardRate").innerText = ethers.utils.formatEther(rewardRate);
      document.getElementById("treasuryBalance").innerText = ethers.utils.formatEther(treasuryBal);
      document.getElementById("topCollectionsCount").innerText = collections.toString();
    }

    async function loadCollections() {
      const addresses = await catalyst.getRegisteredCollections();
      verifiedList = [];
      unverifiedList = [];

      for (let addr of addresses) {
        const config = await catalyst.getCollectionConfig(addr);
        if (config.verified) verifiedList.push(addr);
        else unverifiedList.push(addr);
      }
      renderCollections();
    }

    function renderCollections() {
      const searchV = document.getElementById("searchVerified").value.toLowerCase();
      const searchU = document.getElementById("searchUnverified").value.toLowerCase();

      const vContainer = document.getElementById("verifiedCollections");
      const uContainer = document.getElementById("unverifiedCollections");
      vContainer.innerHTML = "";
      uContainer.innerHTML = "";

      verifiedList.filter(a => a.toLowerCase().includes(searchV))
        .forEach(a => { const li = document.createElement("li"); li.innerText = a; vContainer.appendChild(li); });
      unverifiedList.filter(a => a.toLowerCase().includes(searchU))
        .forEach(a => { const li = document.createElement("li"); li.innerText = a; uContainer.appendChild(li); });
    }

    async function validateAndStake(collection, tokenId, permanent = false) {
      const config = await catalyst.getCollectionConfig(collection);
      if (!config.registered) return alert("Collection not registered");

      const nft = new ethers.Contract(collection, erc721Abi, signer);
      const owner = await nft.ownerOf(tokenId);
      if (owner.toLowerCase() !== (await signer.getAddress()).toLowerCase())
        return alert(`You do not own token ID ${tokenId}`);

      const approved = await nft.getApproved(tokenId);
      if (approved.toLowerCase() !== catalyst.address.toLowerCase()) {
        const txA = await nft.approve(catalyst.address, tokenId);
        await txA.wait();
      }

      const tx = permanent
        ? await catalyst.permanentStake(collection, tokenId)
        : await catalyst.termStake(collection, tokenId);
      await tx.wait();
      alert(`Staked token ${tokenId}`);
    }

    async function validateAndBatchStake(collection, tokenIds, permanent = false) {
      const config = await catalyst.getCollectionConfig(collection);
      if (!config.registered) return alert("Collection not registered");

      const nft = new ethers.Contract(collection, erc721Abi, signer);
      const userAddr = (await signer.getAddress()).toLowerCase();

      for (let id of tokenIds) {
        const owner = await nft.ownerOf(id);
        if (owner.toLowerCase() !== userAddr)
          return alert(`You do not own token ID ${id}`);
      }

      const approvedAll = await nft.isApprovedForAll(userAddr, catalyst.address);
      if (!approvedAll) {
        const txA = await nft.setApprovalForAll(catalyst.address, true);
        await txA.wait();
      }

      const tx = permanent
        ? await catalyst.permanentStakeBatch(collection, tokenIds)
        : await catalyst.termStakeBatch(collection, tokenIds);
      await tx.wait();
      alert(`Batch staked ${tokenIds.length} NFTs`);
    }

    function hookButtons() {
      document.getElementById("stakeTerm").addEventListener("click", async () => {
        const col = prompt("Collection Address:");
        const id = prompt("Token ID:");
        await validateAndStake(col, id, false);
      });
      document.getElementById("stakePermanent").addEventListener("click", async () => {
        const col = prompt("Collection Address:");
        const id = prompt("Token ID:");
        await validateAndStake(col, id, true);
      });
      document.getElementById("batchStake").addEventListener("click", async () => {
        const col = prompt("Collection Address:");
        const ids = prompt("Token IDs (comma separated):").split(",").map(x => x.trim());
        await validateAndBatchStake(col, ids, false);
      });
      document.getElementById("batchUnstake").addEventListener("click", async () => {
        const col = prompt("Collection Address:");
        const ids = prompt("Token IDs (comma separated):").split(",").map(x => x.trim());
        const tx = await catalyst.unstakeBatch(col, ids);
        await tx.wait();
        alert(`Batch unstaked ${ids.length} NFTs`);
      });
      document.getElementById("harvestRewards").addEventListener("click", async () => {
        alert("Harvest logic to be implemented based on contract function signature");
      });
    }
  </script>
</body>
</html>
