<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catalyst DApp — Full Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

<style>
  :root { --bg:#0f1220; --card:#171a2b; --muted:#9aa3b2; --text:#e7ecf4; --acc:#6ee7ff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui, Inter, sans-serif; background:var(--bg); color:var(--text); }
  header { padding:16px 20px; border-bottom:1px solid #20243a; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; opacity:.95; }
  .pill { background:var(--card); padding:8px 10px; border-radius:10px; border:1px solid #232744; display:flex; gap:8px; align-items:center; }
  input, select, button, textarea { background:#0c0f1c; color:var(--text); border:1px solid #27304a; border-radius:10px; padding:10px 12px; outline:none; }
  input, select, textarea { width:100%; }
  button { cursor:pointer; font-weight:600; }
  button.primary { background:#132a39; border-color:#1e3a53; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  main { max-width:1400px; margin:20px auto; padding:0 16px 60px; }
  .grid { display:grid; gap:16px; grid-template-columns:repeat(12,1fr); }
  .card { grid-column:span 12; background:var(--card); border:1px solid #232744; border-radius:16px; padding:16px; }
  @media(min-width:1000px){
    .span7 { grid-column:span 7; }
    .span5 { grid-column:span 5; }
    .span6 { grid-column:span 6; }
    .span4 { grid-column:span 4; }
  }
  .row { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  .row3 { display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr; }
  .label { font-size:12px; color:var(--muted); margin-bottom:6px; }
  .muted { color:var(--muted); }
  .hr { height:1px; background:#232744; margin:14px 0; }
  details { border:1px dashed #2a3154; border-radius:12px; padding:10px 12px; }
  summary { cursor:pointer; font-weight:600; }
  .tabbar { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
  .tabbar button { background:transparent; border:1px solid #27304a; }
  .tabbar button.active { background:#132a39; border-color:#1e3a53; }
  .mono { font-family: ui-monospace, SFMono-Regular, monospace; }
  .kv { display:grid; grid-template-columns: 200px 1fr; gap:6px; }
  .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
</style>
</head>
<body>
<header>
  <h1>⚗️ Catalyst DApp</h1>
  <div class="pill">
    <span class="muted">RPC</span>
    <input id="rpcUrl" placeholder="(optional) e.g. https://rpc…" style="min-width:280px" />
    <button id="saveRpc" class="primary">Use RPC</button>
  </div>
  <div class="pill">
    <span class="muted">Contract</span>
    <input id="contractAddress" placeholder="0x…" style="min-width:280px" />
    <button id="saveContractBtn" class="primary">Save</button>
  </div>
  <div class="pill">
    <span id="acct" class="mono muted">Not connected</span>
    <button id="connectBtn" class="primary">Connect</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: Tabs -->
    <section class="card span7">
      <div class="tabbar">
        <button data-tab="stats" class="active">Stats</button>
        <button data-tab="user">User Info</button>
        <button data-tab="collections">Collections</button>
        <button data-tab="bluechip">Blue-Chip</button>
        <button data-tab="governance">Governance</button>
        <button data-tab="guardians">Guardians</button>
        <button data-tab="admin">Admin</button>
      </div>

      <!-- Stats Tab -->
      <div class="tab" id="tab-stats" style="display:block">
        <h3>Protocol Stats</h3>
        <button id="btnRefreshStats" class="primary">Refresh</button>
        <div class="hr"></div>
        <div id="statsOut" class="mono kv"></div>
      </div>

      <!-- User Info Tab -->
      <div class="tab" id="tab-user" style="display:none">
        <h3>User Info</h3>
        <div class="row">
          <div>
            <div class="label">User Address</div>
            <input id="uAddr" placeholder="0x… (leave blank = your wallet)">
          </div>
          <div>
            <div class="label">Collection</div>
            <input id="uCol" placeholder="0x…">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <div class="label">Token ID</div>
            <input id="uTid" type="number" placeholder="e.g. 1">
          </div>
          <div>
            <div class="label">—</div>
            <button id="btnUserInfo" class="primary">Fetch</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="userOut" class="mono kv"></div>
      </div>

      <!-- Collections Tab -->
      <div class="tab" id="tab-collections" style="display:none">
        <h3>Collections</h3>
        <button id="btnColList" class="primary">Show Registered</button>
        <div class="hr"></div>
        <div id="colOut" class="mono kv"></div>
      </div>

      <!-- Bluechip Tab -->
      <div class="tab" id="tab-bluechip" style="display:none">
        <h3>Blue-Chip</h3>
        <div class="flex">
          <button id="btnEnrollBlue" class="primary">Enroll</button>
          <input id="bcCol" placeholder="0x… collection">
          <button id="btnHarvestBlue">Harvest</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div><input id="bcAdminCol" placeholder="0x…"></div>
          <div>
            <select id="bcFlag">
              <option value="true">Flag as Blue-Chip</option>
              <option value="false">Unflag</option>
            </select>
          </div>
        </div>
        <button id="btnSetBlue" class="primary" style="margin-top:10px">Set</button>
      </div>

      <!-- Governance Tab -->
      <div class="tab" id="tab-governance" style="display:none">
        <h3>Governance</h3>
        <div class="row">
          <div>
            <div class="label">Proposal Type</div>
            <select id="pType">
              <option value="0">BASE_REWARD</option>
              <option value="1">HARVEST_FEE</option>
              <option value="2">UNSTAKE_FEE</option>
              <option value="3">REG_FEE</option>
              <option value="4">VOTING_PARAM</option>
              <option value="5">TIER_UPGRADE</option>
            </select>
          </div>
          <div>
            <div class="label">Target Param</div>
            <input id="pTarget" type="number" value="0">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div><input id="pVal" type="number" placeholder="new value"></div>
          <div><input id="pCtx" placeholder="collection ctx (0x0 ok)"></div>
        </div>
        <button id="btnPropose" class="primary" style="margin-top:10px">Propose</button>
        <div class="hr"></div>
        <input id="propId" placeholder="Proposal ID (bytes32)">
        <div class="flex" style="margin-top:10px">
          <button id="btnVote">Vote</button>
          <button id="btnExecute">Execute</button>
        </div>
      </div>

      <!-- Guardians Tab -->
      <div class="tab" id="tab-guardians" style="display:none">
        <h3>Guardians</h3>
        <button id="btnGuardianList" class="primary">Show Guardians</button>
        <div class="hr"></div>
        <div id="guardianOut" class="mono kv"></div>
      </div>

      <!-- Admin Tab -->
      <div class="tab" id="tab-admin" style="display:none">
        <h3>Admin</h3>
        <div class="flex">
          <button id="btnPause">Pause</button>
          <button id="btnUnpause">Unpause</button>
        </div>
        <div class="hr"></div>
        <input id="toTreasury" placeholder="0x…">
        <input id="amtTreasury" type="number" placeholder="wei amount">
        <button id="btnWithdraw" class="primary" style="margin-top:10px">Withdraw Treasury</button>
      </div>
    </section>

    <!-- RIGHT: Console -->
    <section class="card span5">
      <h3>Console</h3>
      <div id="log" class="mono" style="font-size:12px; white-space:pre-wrap; min-height:400px"></div>
    </section>
  </div>
</main>

<script>
const ABI_URL = "../abi/CatalystNFTStakingUpgradeable.json";
const ERC721_ABI = [
  "function setApprovalForAll(address,bool)",
  "function isApprovedForAll(address,address) view returns (bool)"
];
let READ_PROVIDER, WALLET_PROVIDER, SIGNER, USER_ADDR, ABI, CONTRACT_ADDR, READ_CONTRACT, WRITE_CONTRACT;

const $ = id => document.getElementById(id);
const log = (msg,cls="")=>{const l=$("log");const d=document.createElement("div");d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;if(cls)d.className=cls;l.prepend(d);};

async function loadABI(){if(ABI) return ABI; const j=await (await fetch(ABI_URL)).json(); ABI=Array.isArray(j)?j:(j.abi||j); return ABI;}
async function setupReadProvider(url){READ_PROVIDER=url?new ethers.JsonRpcProvider(url):ethers.getDefaultProvider();}
async function connectWallet(){WALLET_PROVIDER=new ethers.BrowserProvider(window.ethereum);await WALLET_PROVIDER.send("eth_requestAccounts",[]);SIGNER=await WALLET_PROVIDER.getSigner();USER_ADDR=await SIGNER.getAddress();$("acct").textContent=USER_ADDR;}
async function initReadContract(){if(!CONTRACT_ADDR) throw"set contract";if(!READ_PROVIDER) await setupReadProvider();READ_CONTRACT=new ethers.Contract(CONTRACT_ADDR,await loadABI(),READ_PROVIDER);return READ_CONTRACT;}
async function initWriteContract(){if(!SIGNER) await connectWallet();WRITE_CONTRACT=new ethers.Contract(CONTRACT_ADDR,await loadABI(),SIGNER);return WRITE_CONTRACT;}
function addr(v){if(!ethers.isAddress(v)) throw"bad addr"; return v;}

// ---- Events ----
window.addEventListener("load",async()=>{CONTRACT_ADDR=localStorage.getItem("catalyst_contract")||""; if(CONTRACT_ADDR) $("contractAddress").value=CONTRACT_ADDR;});

// ---- Header ----
$("saveContractBtn").onclick=()=>{CONTRACT_ADDR=$("contractAddress").value.trim();localStorage.setItem("catalyst_contract",CONTRACT_ADDR);};
$("saveRpc").onclick=()=>{setupReadProvider($("rpcUrl").value.trim());};
$("connectBtn").onclick=()=>{connectWallet();};

// ---- Tabs ----
document.querySelectorAll(".tabbar button").forEach(b=>b.onclick=()=>{document.querySelectorAll(".tab").forEach(t=>t.style.display="none");document.querySelectorAll(".tabbar button").forEach(x=>x.classList.remove("active"));b.classList.add("active");$("tab-"+b.dataset.tab).style.display="block";});

// ---- Stats ----
$("btnRefreshStats").onclick=async()=>{await initReadContract();const s=await READ_CONTRACT.stakingStats();const t=[["totalAll",s.totalAll],["totalTerm",s.totalTerm],["totalPermanent",s.totalPermanent],["remainingGlobal",s.remainingGlobal],["remainingTerm",s.remainingTerm],["remainingPermanent",s.remainingPermanent],["treasuryBalance",(await READ_CONTRACT.treasuryBalance()).toString()],["paused",(await READ_CONTRACT.paused()).toString()]];$("statsOut").innerHTML=t.map(([k,v])=>`<div>${k}</div><div>${v}</div>`).join("");};

// ---- User ----
$("btnUserInfo").onclick=async()=>{await initReadContract();const u=$("uAddr").value.trim()||USER_ADDR;const c=addr($("uCol").value.trim());const tid=BigInt($("uTid").value||0);const r=await READ_CONTRACT.pendingRewardsView(c,u,tid);const bal=await READ_CONTRACT.balanceOf(u);const burned=await READ_CONTRACT.burnedCatalystByAddress(u);$("userOut").innerHTML=`<div>Address</div><div>${u}</div><div>Collection</div><div>${c}</div><div>Pending</div><div>${r}</div><div>Balance</div><div>${bal}</div><div>Burned</div><div>${burned}</div>`;};

// ---- Collections ----
$("btnColList").onclick=async()=>{await initReadContract();let out="";for(let i=0;i<10;i++){try{const c=await READ_CONTRACT.registeredCollections(i);if(!c) break;const idx=await READ_CONTRACT.registeredIndex(c);const bc=await READ_CONTRACT.isBluechipCollection(c);out+=`<div>${i}</div><div>${c} (idx ${idx}, blue=${bc})</div>`;}catch{break;}}$("colOut").innerHTML=out;};

// ---- Bluechip ----
$("btnEnrollBlue").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.enrollBluechip();await tx.wait();};
$("btnHarvestBlue").onclick=async()=>{await initWriteContract();const c=addr($("bcCol").value);const tx=await WRITE_CONTRACT.harvestBluechip(c);await tx.wait();};
$("btnSetBlue").onclick=async()=>{await initWriteContract();const c=addr($("bcAdminCol").value);const f=$("bcFlag").value==="true";const tx=await WRITE_CONTRACT.setBluechipCollection(c,f);await tx.wait();};

// ---- Governance ----
$("btnPropose").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.propose(Number($("pType").value),Number($("pTarget").value),BigInt($("pVal").value||0),$("pCtx").value||ethers.ZeroAddress);await tx.wait();};
$("btnVote").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.vote($("propId").value.trim());await tx.wait();};
$("btnExecute").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.executeProposal($("propId").value.trim());await tx.wait();};

// ---- Guardians ----
$("btnGuardianList").onclick=async()=>{await initReadContract();let o="";for(let i=0;i<7;i++){try{o+=`<div>Dep[${i}]</div><div>${await READ_CONTRACT.deployerGuardians(i)}</div><div>Adm[${i}]</div><div>${await READ_CONTRACT.adminGuardians(i)}</div>`;}catch{}}$("guardianOut").innerHTML=o;};

// ---- Admin ----
$("btnPause").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.pause();await tx.wait();};
$("btnUnpause").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.unpause();await tx.wait();};
$("btnWithdraw").onclick=async()=>{await initWriteContract();const tx=await WRITE_CONTRACT.withdrawTreasury(addr($("toTreasury").value),BigInt($("amtTreasury").value));await tx.wait();};
</script>
</body>
</html>
