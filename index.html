<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Catalyst Protocol — Modular DApp</title>
  <meta name="description" content="Stake NFTs, enroll blue-chips non-custodially, register collections, govern, and manage guardians. Catalyst (CATA) DApp." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#0b0f14',
            soft: '#111826',
            line: '#1f2a3a',
            brand: { DEFAULT:'#00e5a8', dark:'#00b384' },
            warn: '#fbbf24',
            danger: '#ef4444'
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.25)' }
        }
      }
    }
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { background:#0b0f14; color:#e8f0fb; font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:1.25rem; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .pill { @apply rounded-full border border-line px-3 py-1 text-xs; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-semibold transition active:scale-[.98]; }
    .btn-primary { @apply bg-brand text-ink hover:bg-brand-dark; }
    .btn-ghost   { @apply bg-transparent border border-line hover:border-brand; }
    .btn-danger  { @apply bg-danger text-white hover:bg-red-500; }
    .btn-warn    { @apply bg-warn text-ink hover:bg-yellow-400; }
    .field { @apply w-full rounded-xl bg-soft border border-line px-4 py-3 outline-none focus:border-brand; }
    .tab-active { @apply border-brand text-brand; }
    .link { @apply underline decoration-dotted underline-offset-4 hover:text-brand; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="sticky top-0 z-40 border-b border-line/60 bg-ink/80 backdrop-blur">
    <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg" style="background:conic-gradient(from 180deg at 50% 50%, #00e5a8 0deg, #5eead4 120deg, #60a5fa 240deg, #00e5a8 360deg);"></div>
        <span class="text-lg font-extrabold tracking-tight">Catalyst Protocol</span>
      </div>
      <div class="hidden items-center gap-6 md:flex">
        <a href="#app" class="hover:text-brand">App</a>
        <a href="#docs" class="hover:text-brand">Docs</a>
        <a href="#faq" class="hover:text-brand">FAQ</a>
      </div>
      <div class="flex items-center gap-2">
        <div class="pill flex items-center gap-2">Network: <span id="networkName" class="ml-1 font-semibold">—</span></div>
        <button id="connectBtn" class="btn btn-primary">Connect</button>
      </div>
    </nav>
  </header>

  <!-- HERO -->
  <section class="relative overflow-hidden border-b border-line/60">
    <div class="pointer-events-none absolute inset-0 opacity-30" style="background: radial-gradient(800px 400px at 10% 10%, rgba(0,229,168,.25), transparent), radial-gradient(800px 400px at 90% 20%, rgba(96,165,250,.25), transparent);"></div>
    <div class="mx-auto grid max-w-7xl items-center gap-10 px-4 py-14 md:grid-cols-2">
      <div>
        <div class="mb-4 inline-flex items-center gap-2 rounded-full border border-line px-3 py-1 text-xs">NFT-Neutral Utility • Deflationary Tokenomics</div>
        <h1 class="mb-3 text-4xl font-extrabold leading-tight md:text-5xl">Stake any ERC-721. Earn CATA. <span class="text-brand">Govern together.</span></h1>
        <p class="mb-6 max-w-xl text-white/80">
          Catalyst lets any ERC-721 earn CATA through custodial staking, or non-custodially via blue-chip enrollment.
          Governance is burn-weighted with stake-age, and security is backed by guardian councils.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="#app" class="btn btn-primary">Launch App</a>
          <a href="#docs" class="btn btn-ghost">Read Docs</a>
        </div>
      </div>
      <div class="card p-6">
        <div class="mb-4 text-sm text-white/70">Quick Wallet</div>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-3">
          <div class="rounded-xl border border-line p-4">
            <div class="text-xs text-white/60">Address</div>
            <div id="walletShort" class="truncate text-lg font-semibold">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="text-xs text-white/60">Chain</div>
            <div id="chainId" class="text-lg font-semibold">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="text-xs text-white/60">CATA</div>
            <div id="cataBal" class="text-lg font-semibold">—</div>
          </div>
        </div>
        <div class="mt-4 text-xs text-white/60">* Post-tx balances refresh automatically.</div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="relative">
    <div class="pointer-events-none absolute inset-0 opacity-20" style="background: radial-gradient(800px 400px at 20% 80%, rgba(94,234,212,.22), transparent), radial-gradient(800px 400px at 80% 60%, rgba(99,102,241,.18), transparent);"></div>
    <div class="mx-auto max-w-7xl px-4 py-12">
      <!-- Contract selector -->
      <div class="mb-6 card p-5">
        <div class="flex flex-wrap items-end justify-between gap-3">
          <div>
            <h2 class="text-2xl font-extrabold">DApp</h2>
            <p class="text-white/70">Set the proxy address, then use tabs for write & read modules.</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="contractAddress" class="field w-[25rem]" placeholder="Catalyst proxy address (0x…)" />
            <button id="saveContractBtn" class="btn btn-ghost">Save</button>
          </div>
        </div>
        <div class="mt-3 grid gap-3 text-sm md:grid-cols-3">
          <div class="rounded-xl border border-line p-3">
            <div class="text-white/60">Active contract</div>
            <div id="activeContract" class="mono break-all">—</div>
          </div>
          <div class="rounded-xl border border-line p-3">
            <div class="text-white/60">Wallet</div>
            <div id="walletAddress" class="mono break-all">—</div>
          </div>
          <div class="rounded-xl border border-line p-3">
            <div class="text-white/60">Chain ID</div>
            <div id="walletChain" class="mono break-all">—</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-4 flex flex-wrap gap-2">
        <button data-tab="bluechip"   class="tab-btn btn btn-ghost">Blue-Chip</button>
        <button data-tab="stake"      class="tab-btn btn btn-ghost">Stake</button>
        <button data-tab="register"   class="tab-btn btn btn-ghost">Register</button>
        <button data-tab="governance" class="tab-btn btn btn-ghost">Governance</button>
        <button data-tab="guardians"  class="tab-btn btn btn-ghost">Guardians</button>
        <button data-tab="treasury"   class="tab-btn btn btn-ghost">Treasury</button>
        <button data-tab="views"      class="tab-btn btn btn-ghost">Read-Only</button>
        <button data-tab="info"       class="tab-btn btn btn-ghost">Whitepaper</button>
      </div>

      <!-- Panels -->
      <div id="panel-bluechip" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Blue-Chip (Non-Custodial)</h3><span class="pill">Write</span></div>
        <div class="grid gap-3 md:grid-cols-[1fr_auto]">
          <button id="bcEnroll" class="btn btn-primary md:justify-self-start">Enroll Wallet</button>
          <div class="grid grid-cols-1 gap-3 md:grid-cols-[1fr_auto]">
            <input id="bcCollection" class="field" placeholder="Blue-chip collection address" />
            <button id="bcHarvest" class="btn btn-ghost">Harvest</button>
          </div>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-line p-4">
            <div class="mb-2 text-sm text-white/60">Read</div>
            <div class="flex gap-2">
              <input id="bcReadAddr" class="field" placeholder="User address (optional)" />
              <button id="bcIsEnrolled" class="btn btn-ghost">Is Enrolled?</button>
            </div>
            <div id="bcReadOut" class="mt-2 mono text-white/70">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="mb-2 text-sm text-white/60">Learn</div>
            <p class="text-white/70 text-sm">
              Enroll once <em>per wallet</em>. Then harvest rewards for any flagged blue-chip collection you hold —
              custody remains with you. This aligns with the whitepaper’s blue-chip model that avoids custodial risk.
            </p>
          </div>
        </div>
      </div>

      <div id="panel-stake" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Stake (Custodial)</h3><span class="pill">Write</span></div>
        <div class="grid gap-3 md:grid-cols-2">
          <input id="stCollection" class="field" placeholder="ERC-721 collection address" />
          <input id="stTokenIds" class="field" placeholder="Token IDs (comma separated)" />
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm text-white/80">
            <input id="stPermanent" type="checkbox" class="h-4 w-4 accent-brand" />
            Permanent (higher rewards, irreversible)
          </label>
          <button id="stBatch" class="btn btn-primary">Batch Stake</button>
          <button id="stHarvestOne" class="btn btn-ghost">Harvest (single)</button>
          <button id="stUnstakeOne" class="btn btn-ghost">Unstake (single)</button>
        </div>
        <div class="mt-3 grid gap-3 md:grid-cols-2">
          <input id="stSingleTokenId" class="field" placeholder="Token ID for harvest/unstake" />
          <div class="text-sm text-white/60">Batch stake supports up to the contract’s limit; front-end recommends ≤ 50 per batch on L1.</div>
        </div>
        <hr class="my-6 border-line/70" />
        <div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-line p-4">
            <div class="text-sm text-white/60 mb-1">Read</div>
            <div class="grid gap-2">
              <div class="flex gap-2">
                <input id="stViewOwner" class="field" placeholder="Owner (blank = connected wallet)" />
                <input id="stViewCol" class="field" placeholder="Collection" />
              </div>
              <div class="flex gap-2">
                <input id="stViewToken" class="field" placeholder="Token ID" />
                <button id="stViewPending" class="btn btn-ghost">View Pending</button>
              </div>
            </div>
            <div id="stPendingOut" class="mt-2 mono text-white/70">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="text-sm text-white/60 mb-1">Learn</div>
            <ul class="list-disc pl-5 text-sm text-white/70 space-y-1">
              <li><b>Term</b> vs <b>Permanent</b>: term unlocks at end; permanent locks forever for higher rewards.</li>
              <li>Fees follow immutable 90% burn / 9% treasury / 1% deployer split.</li>
              <li>Global & per-collection caps exist to protect sustainability.</li>
            </ul>
          </div>
        </div>
      </div>

      <div id="panel-register" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Register Collection</h3><span class="pill">Write</span></div>
        <div class="grid gap-3 md:grid-cols-3">
          <input id="regCollection" class="field" placeholder="Collection address" />
          <input id="regDeclared" class="field" type="number" placeholder="Declared max supply (≤ 20,000)" />
          <button id="regSubmit" class="btn btn-primary">Register</button>
        </div>
        <p class="mt-3 text-sm text-white/70">Permissionless registration; unverified collections may pay surcharges and have reduced rights until upgrade conditions are met.</p>
        <hr class="my-6 border-line/70" />
        <div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-line p-4">
            <div class="text-sm text-white/60 mb-1">Read</div>
            <div class="flex gap-2">
              <input id="regReadCol" class="field" placeholder="Collection address" />
              <button id="regReadBtn" class="btn btn-ghost">Get Info</button>
            </div>
            <div id="regReadOut" class="mt-2 mono text-white/70">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="text-sm text-white/60 mb-1">Learn</div>
            <p class="text-white/70 text-sm">
              Registered collections receive reward schedules and staking slots as per whitepaper caps. Governance can upgrade unverified collections after burn/proof requirements.
            </p>
          </div>
        </div>
      </div>

      <div id="panel-governance" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Governance</h3><span class="pill">Write</span></div>
        <div class="grid gap-3 md:grid-cols-3">
          <select id="govType" class="field">
            <option value="0">BASE_REWARD</option>
            <option value="1">HARVEST_FEE</option>
            <option value="2">UNSTAKE_FEE</option>
            <option value="3">REGISTRATION_FEE_FALLBACK</option>
            <option value="4">VOTING_PARAM</option>
            <option value="5">TIER_UPGRADE</option>
          </select>
          <input id="govParamTarget" class="field" type="number" placeholder="Param target (for VOTING_PARAM)" />
          <input id="govNewValue" class="field" type="number" placeholder="New value (uint256)" />
        </div>
        <div class="mt-3 grid gap-3 md:grid-cols-[1fr_auto_auto]">
          <input id="govCollCtx" class="field" placeholder="Collection context (optional 0x… or 0x0)" />
          <button id="govPropose" class="btn btn-primary">Create Proposal</button>
          <button id="govList" class="btn btn-ghost">List Proposals</button>
        </div>
        <hr class="my-6 border-line/70" />
        <div class="grid gap-3 md:grid-cols-[1fr_auto_auto]">
          <input id="govPropId" class="field" placeholder="Proposal ID (bytes32)" />
          <button id="govVote" class="btn btn-ghost">Vote</button>
          <button id="govExecute" class="btn btn-primary">Execute</button>
        </div>
        <div id="govOut" class="mt-3 mono text-white/70">—</div>
        <div class="mt-4 rounded-xl border border-line p-4 text-sm text-white/70">
          <b>Learn:</b> Burn-Weighted Collection Governance (BWCG) ties voting power to burned CATA and stake-age,
          with per-collection caps. The immutable 90/9/1 split cannot be changed by governance.
        </div>
      </div>

      <div id="panel-guardians" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Guardian Councils</h3><span class="pill">Write</span></div>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-line p-4">
            <h4 class="mb-2 font-semibold">Deployer Council (7:5)</h4>
            <div class="grid gap-2 md:grid-cols-[1fr_auto_auto]">
              <input id="gdNewDeployer" class="field" placeholder="Proposed new deployer" />
              <button id="gdPropDep" class="btn btn-ghost">Propose</button>
              <button id="gdApproveDep" class="btn btn-ghost">Approve</button>
            </div>
            <div class="mt-2 flex justify-end">
              <button id="gdExecDep" class="btn btn-primary">Execute (confirm)</button>
            </div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <h4 class="mb-2 font-semibold">Admin Council (7:5)</h4>
            <div class="grid gap-2 md:grid-cols-[1fr_auto_auto]">
              <input id="gdNewAdmin" class="field" placeholder="Proposed new admin" />
              <button id="gdPropAdm" class="btn btn-ghost">Propose</button>
              <button id="gdApproveAdm" class="btn btn-ghost">Approve</button>
            </div>
            <div class="mt-2 flex justify-end">
              <button id="gdExecAdm" class="btn btn-primary">Execute (confirm)</button>
            </div>
          </div>
        </div>
        <hr class="my-6 border-line/70" />
        <div class="rounded-xl border border-line p-4">
          <h4 class="mb-2 font-semibold">Set Guardian (Admin-only)</h4>
          <div class="grid gap-2 md:grid-cols-4">
            <select id="gdWhich" class="field">
              <option value="dep">Deployer</option>
              <option value="adm">Admin</option>
            </select>
            <input id="gdIdx" type="number" min="0" max="6" class="field" placeholder="Index 0–6" />
            <input id="gdAddr" class="field" placeholder="Guardian address" />
            <button id="gdSet" class="btn btn-ghost">Set</button>
          </div>
          <p class="mt-2 text-sm text-white/70">Zero-address is rejected (ZeroGuardianNotAllowed). Emits GuardianSet(index, addr).</p>
        </div>
        <div id="gdOut" class="mt-3 mono text-white/70">—</div>
      </div>

      <div id="panel-treasury" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Treasury</h3><span class="pill">Write</span></div>
        <div class="grid gap-3 md:grid-cols-3">
          <input id="twTo" class="field" placeholder="Withdraw to (0x…)" />
          <input id="twAmt" class="field" type="text" placeholder="Amount (wei)" />
          <button id="twBtn" class="btn btn-danger">Withdraw (confirm)</button>
        </div>
        <hr class="my-6 border-line/70" />
        <div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-line p-4">
            <div class="mb-2 text-sm text-white/60">Read</div>
            <div class="flex gap-2">
              <button id="twBalance" class="btn btn-ghost">Treasury Balance</button>
              <button id="twDeployer" class="btn btn-ghost">Deployer Address</button>
              <button id="twPaused" class="btn btn-ghost">Paused?</button>
            </div>
            <div id="twOut" class="mt-2 mono text-white/70">—</div>
          </div>
          <div class="rounded-xl border border-line p-4">
            <div class="mb-2 text-sm text-white/60">Learn</div>
            <p class="text-sm text-white/70">
              Fees follow immutable 90/9/1 split. Treasury withdrawals require admin role and are logged for monitoring.
            </p>
          </div>
        </div>
      </div>

      <div id="panel-views" class="panel card p-6 hidden">
        <div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-semibold">Read-Only Helpers</h3><span class="pill">Read</span></div>
        <div class="grid gap-3 md:grid-cols-3">
          <button id="vwStats" class="btn btn-ghost">Protocol Stats</button>
          <button id="vwCollections" class="btn btn-ghost">Registered Collections</button>
          <button id="vwBluechips" class="btn btn-ghost">Blue-Chip List</button>
        </div>
        <div id="vwOut" class="mt-3 mono text-white/70">—</div>
      </div>

      <div id="panel-info" class="panel card p-6 hidden">
        <h3 class="text-xl font-semibold mb-2">Whitepaper Overview</h3>
        <p class="text-white/70">
          Catalyst is a universal NFT staking & governance protocol. It supports custodial staking for any ERC-721,
          and non-custodial rewards for blue-chips. Governance is burn-weighted with stake-age; fees are immutably split
          90% burn / 9% treasury / 1% deployer. Security uses 7-member guardian councils (5-of-7 default) for both
          deployer and admin roles with recovery & compromise detection.
        </p>
        <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-white/70">
          <li>Per-collection cap: 20,000 NFTs.</li>
          <li>Global cap: e.g., 1B NFTs (split term vs permanent as per deployment params).</li>
          <li>Blue-chip enrollment is per-wallet (one-time); harvesting is per-collection you hold.</li>
        </ul>
      </div>

      <!-- Activity log -->
      <div class="mt-6 card p-6">
        <div class="mb-2 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Activity</h3>
          <button id="logClear" class="btn btn-ghost">Clear</button>
        </div>
        <div id="log" class="max-h-72 overflow-auto rounded-xl border border-line/60 bg-soft/60 p-3 text-sm mono"></div>
      </div>
    </div>
  </section>

  <!-- DOCS / FAQ -->
  <section id="docs" class="border-t border-line/60">
    <div class="mx-auto max-w-7xl px-4 py-12">
      <h2 class="mb-4 text-2xl font-extrabold">Docs (Quick)</h2>
      <div class="grid gap-6 md:grid-cols-2">
        <div class="card p-5">
          <h3 class="mb-2 text-xl font-semibold">Security</h3>
          <ul class="list-disc space-y-2 pl-6 text-white/80">
            <li>Guardian councils (7 members each) approve sensitive recoveries (5-of-7).</li>
            <li>Upgradeable (UUPS) & pausable with broad coverage on write paths.</li>
            <li>Events emitted for monitoring: enrollments, harvests, proposals, recoveries.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="mb-2 text-xl font-semibold">Tokenomics</h3>
          <ul class="list-disc space-y-2 pl-6 text-white/80">
            <li>90% burn • 9% treasury • 1% deployer (immutable split).</li>
            <li>Deflationary pressure on harvest, unstake, registration, and burns.</li>
            <li>Top burner incentives & DAO control over treasury allocations.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="border-t border-line/60">
    <div class="mx-auto max-w-7xl px-4 py-12">
      <h2 class="mb-4 text-2xl font-extrabold">FAQ</h2>
      <div class="grid gap-6 md:grid-cols-2">
        <div class="card p-5">
          <h3 class="mb-2 font-semibold">Is blue-chip enrollment per collection?</h3>
          <p class="text-white/80 text-sm">
            No — it’s per <em>wallet</em>. Once enrolled, you can harvest any flagged blue-chip collection you hold.
          </p>
        </div>
        <div class="card p-5">
          <h3 class="mb-2 font-semibold">Can the default admin change guardians?</h3>
          <p class="text-white/80 text-sm">
            Yes, via admin functions. However, guardian councils control recovery flows and enforce thresholds.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="border-t border-line/60">
    <div class="mx-auto flex max-w-7xl flex-col items-center justify-between gap-6 px-4 py-10 md:flex-row">
      <div class="text-white/60">© <span id="year"></span> Catalyst Protocol</div>
      <div class="flex items-center gap-4 text-sm text-white/60">
        <a class="link" href="#docs">Docs</a>
        <a class="link" href="#faq">FAQ</a>
        <a class="link" href="#">GitHub</a>
      </div>
    </div>
  </footer>

  <!-- MODALS -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
    <div class="card w-full max-w-lg p-6">
      <h3 id="modalTitle" class="text-xl font-bold mb-2">Confirm</h3>
      <p id="modalBody" class="text-white/80 mb-4"></p>
      <div id="modalExtra" class="text-xs text-white/60 mb-4"></div>
      <div class="flex justify-end gap-2">
        <button id="modalCancel" class="btn btn-ghost">Cancel</button>
        <button id="modalConfirm" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- APP (Modules) -->
  <script type="module">
  // =============== Core ===============
  const Core = (() => {
    let provider = null, signer = null, account = null, contract = null, abi = null;
    const state = { contractAddr: '', chainId: null, networkName: '—' };
    const logEl = document.getElementById('log');

    const $ = (id) => document.getElementById(id);
    const isAddr = (a)=> /^0x[a-fA-F0-9]{40}$/.test(a);

    function log(msg, type='info'){
      const time = new Date().toLocaleTimeString();
      const color = type==='error' ? 'text-red-400' : type==='success' ? 'text-emerald-400' : 'text-white/80';
      const div = document.createElement('div'); div.className=color; div.textContent=`[${time}] ${msg}`; logEl.prepend(div);
    }

    async function fetchABI() {
      if (abi) return abi;
      const res = await fetch('../abi/CatalystNFTStakingUpgradeable.json', { cache:'no-store' });
      if(!res.ok) throw new Error('Failed to fetch ABI');
      const json = await res.json();
      abi = Array.isArray(json) ? json : (json.abi || json);
      log(`ABI loaded (${abi.length})`, 'success');
      return abi;
    }

    async function ensureProvider() {
      if (!window.ethereum) throw new Error('No injected wallet found');
      if (!provider) provider = new ethers.BrowserProvider(window.ethereum, 'any');
      return provider;
    }

    async function connectWallet() {
      await ensureProvider();
      const accounts = await provider.send('eth_requestAccounts', []);
      account = accounts[0];
      signer = await provider.getSigner();
      const net = await provider.getNetwork();
      state.chainId = Number(net.chainId);
      state.networkName = net.name || `chain ${state.chainId}`;
      updateWalletUi();
      log(`Connected ${account}`, 'success');
      window.ethereum?.on?.('accountsChanged', ()=>window.location.reload());
      window.ethereum?.on?.('chainChanged', ()=>window.location.reload());
    }

    function updateWalletUi() {
      $('#walletShort').textContent = account ? `${account.slice(0,6)}…${account.slice(-4)}` : '—';
      $('#walletAddress').textContent = account || '—';
      $('#walletChain').textContent = state.chainId ?? '—';
      $('#chainId').textContent = state.chainId ?? '—';
      $('#networkName').textContent = state.networkName;
    }

    async function setContract(addr) {
      if (!isAddr(addr)) throw new Error('Invalid contract address');
      state.contractAddr = addr;
      localStorage.setItem('catalyst:contract', addr);
      $('#activeContract').textContent = addr;
      const _abi = await fetchABI();
      contract = new ethers.Contract(addr, _abi, signer || provider);
      log(`Contract set: ${addr}`, 'success');
    }

    function loadSavedContract() {
      const saved = localStorage.getItem('catalyst:contract');
      if (saved) {
        $('#contractAddress').value = saved;
        $('#activeContract').textContent = saved;
        state.contractAddr = saved;
      }
    }

    function get() { return { provider, signer, account, contract, abi }; }
    async function ensureContract() {
      if (!contract) {
        const addr = document.getElementById('contractAddress').value.trim() || state.contractAddr;
        if (!isAddr(addr)) throw new Error('Set a valid contract address first');
        await setContract(addr);
      }
      return contract;
    }

    async function cataBalance() {
      try {
        const { contract } = get(); if (!contract || !account) return;
        const bal = await contract.balanceOf(account);
        const pretty = ethers.formatUnits(bal, 18);
        document.getElementById('cataBal').textContent = pretty;
      } catch { /* optional */ }
    }

    return { $, log, get, ensureProvider, connectWallet, setContract, loadSavedContract, ensureContract, cataBalance, isAddr, state };
  })();

  // =============== UI (modal/toast helpers) ===============
  const UI = (() => {
    const modal = Core.$('modal');
    const title = Core.$('modalTitle');
    const body  = Core.$('modalBody');
    const extra = Core.$('modalExtra');
    const btnOk = Core.$('modalConfirm');
    const btnNo = Core.$('modalCancel');

    function confirm({title:textTitle, html, note}, onOk) {
      title.textContent = textTitle || 'Confirm';
      body.innerHTML = html || '';
      extra.textContent = note || '';
      modal.classList.remove('hidden','opacity-0');
      const ok = ()=>{ cleanup(); onOk?.(); };
      const no = ()=> cleanup();
      function cleanup(){
        btnOk.removeEventListener('click', ok);
        btnNo.removeEventListener('click', no);
        modal.classList.add('hidden');
      }
      btnOk.addEventListener('click', ok);
      btnNo.addEventListener('click', no);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) no(); }, { once:true });
    }

    return { confirm };
  })();

  // =============== BlueChip Module ===============
  const BlueChip = (() => {
    const el = {
      enroll: Core.$('bcEnroll'),
      harvest: Core.$('bcHarvest'),
      col: Core.$('bcCollection'),
      readBtn: Core.$('bcIsEnrolled'),
      readAddr: Core.$('bcReadAddr'),
      out: Core.$('bcReadOut')
    };

    el.enroll.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).enrollBluechip();
        Core.log(`Enroll submitted: ${tx.hash}`);
        await tx.wait();
        Core.log('Blue-chip enrollment confirmed ✅','success');
        await Core.cataBalance();
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.harvest.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const c = el.col.value.trim();
        if (!Core.isAddr(c)) throw new Error('Invalid collection address');
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).harvestBluechip(c);
        Core.log(`Blue-chip harvest: ${tx.hash}`);
        await tx.wait();
        Core.log('Blue-chip harvest confirmed ✅','success');
        await Core.cataBalance();
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.readBtn.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { account, contract } = Core.get();
        const who = (el.readAddr.value.trim() || account);
        if (!Core.isAddr(who)) throw new Error('Invalid address');
        // Example view: isBluechipEnrolled(address) — adjust if named differently
        let enrolled = false;
        try { enrolled = await contract.isBluechipEnrolled(who); }
        catch { enrolled = '(view not found; add isBluechipEnrolled(address) to ABI if present)'; }
        el.out.textContent = `Enrolled: ${String(enrolled)}`;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });
    return {};
  })();

  // =============== Stake Module ===============
  const Stake = (() => {
    const el = {
      col: Core.$('stCollection'), ids: Core.$('stTokenIds'), perm: Core.$('stPermanent'),
      batch: Core.$('stBatch'), harvest: Core.$('stHarvestOne'), unstake: Core.$('stUnstakeOne'),
      singleId: Core.$('stSingleTokenId'),
      vOwner: Core.$('stViewOwner'), vCol: Core.$('stViewCol'), vTok: Core.$('stViewToken'),
      vBtn: Core.$('stViewPending'), vOut: Core.$('stPendingOut')
    };

    el.batch.addEventListener('click', async ()=>{
      try{
        const collection = el.col.value.trim();
        if (!Core.isAddr(collection)) throw new Error('Invalid collection address');
        const ids = el.ids.value.split(',').map(s=>s.trim()).filter(Boolean).map(BigInt);
        if (!ids.length) throw new Error('Provide token IDs');
        const permanent = el.perm.checked;

        if (permanent) {
          UI.confirm({
            title:'Confirm Permanent Stake',
            html:`<div class="text-sm text-white/80">You are about to <b>permanently</b> lock ${ids.length} NFTs in the protocol for higher rewards. This action cannot be reversed.</div>`,
            note:'Proceed only if you understand the irreversible lock.'
          }, async ()=>{
            try{
              await Core.ensureProvider(); await Core.ensureContract();
              const { signer, contract } = Core.get();
              const tx = await contract.connect(signer).batchStake(collection, ids, true);
              Core.log(`Permanent batch stake: ${tx.hash}`);
              await tx.wait();
              Core.log('Permanent stake confirmed ✅','success');
            }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
          });
        } else {
          await Core.ensureProvider(); await Core.ensureContract();
          const { signer, contract } = Core.get();
          const tx = await contract.connect(signer).batchStake(collection, ids, false);
          Core.log(`Batch stake: ${tx.hash}`);
          await tx.wait();
          Core.log('Batch stake confirmed ✅','success');
        }
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.harvest.addEventListener('click', async ()=>{
      try{
        const collection = el.col.value.trim();
        const tokenId = el.singleId.value.trim();
        if (!Core.isAddr(collection)) throw new Error('Invalid collection address');
        if (!tokenId) throw new Error('Provide token ID');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).harvest(collection, BigInt(tokenId));
        Core.log(`Harvest: ${tx.hash}`);
        await tx.wait();
        Core.log('Harvest confirmed ✅','success');
        await Core.cataBalance();
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.unstake.addEventListener('click', async ()=>{
      try{
        const collection = el.col.value.trim();
        const tokenId = el.singleId.value.trim();
        if (!Core.isAddr(collection)) throw new Error('Invalid collection address');
        if (!tokenId) throw new Error('Provide token ID');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        if (!contract.unstake) throw new Error('unstake(address,uint256) missing in ABI');
        const tx = await contract.connect(signer).unstake(collection, BigInt(tokenId));
        Core.log(`Unstake: ${tx.hash}`);
        await tx.wait();
        Core.log('Unstake confirmed ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.vBtn.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const owner = el.vOwner.value.trim() || Core.get().account;
        const col   = el.vCol.value.trim();
        const tok   = el.vTok.value.trim();
        if (!Core.isAddr(owner)) throw new Error('Invalid owner address');
        if (!Core.isAddr(col)) throw new Error('Invalid collection address');
        if (!tok) throw new Error('Provide token ID');
        // Example view: pendingRewards(address owner, address col, uint256 tokenId)
        const { contract } = Core.get();
        let res = 'n/a';
        try { res = await contract.pendingRewards(owner, col, BigInt(tok)); }
        catch { res = '(view fn name may differ: add pendingRewards to ABI)'; }
        el.vOut.textContent = `Pending: ${String(res)}`;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    return {};
  })();

  // =============== Registration Module ===============
  const Registration = (() => {
    const el = {
      col: Core.$('regCollection'), dec: Core.$('regDeclared'), btn: Core.$('regSubmit'),
      rCol: Core.$('regReadCol'), rBtn: Core.$('regReadBtn'), rOut: Core.$('regReadOut')
    };

    el.btn.addEventListener('click', async ()=>{
      try{
        const col = el.col.value.trim(); if (!Core.isAddr(col)) throw new Error('Invalid collection address');
        const declared = BigInt(el.dec.value || '0');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).registerCollection(col, declared);
        Core.log(`Register collection: ${tx.hash}`);
        await tx.wait();
        Core.log('Collection registered ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.rBtn.addEventListener('click', async ()=>{
      try{
        const c = el.rCol.value.trim(); if (!Core.isAddr(c)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { contract } = Core.get();
        let info = {};
        try { info = await contract.getCollectionInfo(c); }
        catch { info = '(getCollectionInfo missing; add to ABI)'; }
        el.rOut.textContent = typeof info === 'string' ? info : JSON.stringify(info, null, 2);
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    return {};
  })();

  // =============== Governance Module ===============
  const Governance = (() => {
    const el = {
      type: Core.$('govType'), target: Core.$('govParamTarget'), val: Core.$('govNewValue'),
      ctx: Core.$('govCollCtx'), propose: Core.$('govPropose'), list: Core.$('govList'),
      id: Core.$('govPropId'), vote: Core.$('govVote'), exec: Core.$('govExecute'),
      out: Core.$('govOut')
    };

    el.propose.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const pType = BigInt(el.type.value);
        const pTarget = BigInt(el.target.value || '0');
        const newVal = BigInt(el.val.value || '0');
        const ctx = (el.ctx.value.trim() || '0x0000000000000000000000000000000000000000');
        const tx = await contract.connect(signer).createProposal(pType, pTarget, newVal, ctx);
        Core.log(`Create proposal: ${tx.hash}`);
        await tx.wait();
        Core.log('Proposal created ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.list.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { contract } = Core.get();
        let list = [];
        try { list = await contract.listProposals?.() ?? '(listProposals missing; add to ABI)'; }
        catch { list = '(listProposals missing; add to ABI)'; }
        el.out.textContent = typeof list === 'string' ? list : JSON.stringify(list, null, 2);
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    el.vote.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const id = el.id.value.trim(); if (!id) throw new Error('Provide proposal ID');
        const tx = await contract.connect(signer).vote(id);
        Core.log(`Vote: ${tx.hash}`);
        await tx.wait();
        Core.log('Vote confirmed ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.exec.addEventListener('click', async ()=>{
      const id = el.id.value.trim(); if (!id) { Core.log('Provide proposal ID','error'); return; }
      UI.confirm({
        title:'Execute Proposal',
        html:`<div class="text-sm text-white/80">Execute proposal <span class="mono">${id}</span>? This action applies changes on-chain.</div>`,
        note:'Ensure quorum & endBlock conditions are met.'
      }, async ()=>{
        try{
          await Core.ensureProvider(); await Core.ensureContract();
          const { signer, contract } = Core.get();
          const tx = await contract.connect(signer).execute(id);
          Core.log(`Execute proposal: ${tx.hash}`);
          await tx.wait();
          Core.log('Proposal executed ✅','success');
        }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
      });
    });

    return {};
  })();

  // =============== Guardians Module ===============
  const Guardians = (() => {
    const el = {
      newDep: Core.$('gdNewDeployer'), propDep: Core.$('gdPropDep'), aprDep: Core.$('gdApproveDep'), exeDep: Core.$('gdExecDep'),
      newAdm: Core.$('gdNewAdmin'),   propAdm: Core.$('gdPropAdm'), aprAdm: Core.$('gdApproveAdm'), exeAdm: Core.$('gdExecAdm'),
      which:  Core.$('gdWhich'), idx:  Core.$('gdIdx'), addr: Core.$('gdAddr'), setBtn: Core.$('gdSet'),
      out: Core.$('gdOut')
    };

    el.propDep.addEventListener('click', async ()=>{
      try{
        const a = el.newDep.value.trim(); if (!Core.isAddr(a)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).guardianProposeDeployer(a);
        Core.log(`Propose new deployer: ${tx.hash}`);
        await tx.wait(); Core.log('Proposal submitted ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.aprDep.addEventListener('click', async ()=>{
      try{
        const a = el.newDep.value.trim(); if (!Core.isAddr(a)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).guardianApproveDeployer(a);
        Core.log(`Approve deployer change: ${tx.hash}`);
        await tx.wait(); Core.log('Approval recorded ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.exeDep.addEventListener('click', ()=>{
      const a = el.newDep.value.trim(); if (!Core.isAddr(a)) { Core.log('Invalid address','error'); return; }
      UI.confirm({
        title:'Execute Deployer Recovery',
        html:`<div class="text-sm text-white/80">Execute deployer recovery to <span class="mono">${a}</span>?</div>`,
        note:'Requires threshold approvals; emits recovery events.'
      }, async ()=>{
        try{
          await Core.ensureProvider(); await Core.ensureContract();
          const { signer, contract } = Core.get();
          const tx = await contract.connect(signer).guardianExecuteDeployer(a);
          Core.log(`Execute deployer recovery: ${tx.hash}`);
          await tx.wait(); Core.log('Deployer recovery executed ✅','success');
        }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
      });
    });

    el.propAdm.addEventListener('click', async ()=>{
      try{
        const a = el.newAdm.value.trim(); if (!Core.isAddr(a)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).guardianProposeAdmin(a);
        Core.log(`Propose new admin: ${tx.hash}`);
        await tx.wait(); Core.log('Proposal submitted ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.aprAdm.addEventListener('click', async ()=>{
      try{
        const a = el.newAdm.value.trim(); if (!Core.isAddr(a)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const tx = await contract.connect(signer).guardianApproveAdmin(a);
        Core.log(`Approve admin change: ${tx.hash}`);
        await tx.wait(); Core.log('Approval recorded ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    el.exeAdm.addEventListener('click', ()=>{
      const a = el.newAdm.value.trim(); if (!Core.isAddr(a)) { Core.log('Invalid address','error'); return; }
      UI.confirm({
        title:'Execute Admin Recovery',
        html:`<div class="text-sm text-white/80">Execute admin recovery to <span class="mono">${a}</span>?</div>`,
        note:'Requires threshold approvals; emits recovery events.'
      }, async ()=>{
        try{
          await Core.ensureProvider(); await Core.ensureContract();
          const { signer, contract } = Core.get();
          const tx = await contract.connect(signer).guardianExecuteAdmin(a);
          Core.log(`Execute admin recovery: ${tx.hash}`);
          await tx.wait(); Core.log('Admin recovery executed ✅','success');
        }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
      });
    });

    el.setBtn.addEventListener('click', async ()=>{
      try{
        const idx = Number(el.idx.value); const a = el.addr.value.trim();
        if (!(idx>=0 && idx<=6)) throw new Error('Index 0–6');
        if (!Core.isAddr(a)) throw new Error('Invalid address');
        await Core.ensureProvider(); await Core.ensureContract();
        const { signer, contract } = Core.get();
        const isDep = el.which.value==='dep';
        const fn = isDep ? 'setDeployerGuardian' : 'setAdminGuardian';
        const tx = await contract.connect(signer)[fn](idx, a);
        Core.log(`Set ${isDep?'deployer':'admin'} guardian[${idx}]: ${tx.hash}`);
        await tx.wait(); Core.log('Guardian set ✅','success');
      }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
    });

    return {};
  })();

  // =============== Treasury Module ===============
  const Treasury = (() => {
    const el = { to: Core.$('twTo'), amt: Core.$('twAmt'), btn: Core.$('twBtn'), out: Core.$('twOut'),
      bal: Core.$('twBalance'), dep: Core.$('twDeployer'), paused: Core.$('twPaused') };

    el.btn.addEventListener('click', ()=>{
      const to = el.to.value.trim(); const amt = el.amt.value.trim();
      if (!Core.isAddr(to)) { Core.log('Invalid recipient','error'); return; }
      if (!/^\d+$/.test(amt)) { Core.log('Amount must be wei integer','error'); return; }
      UI.confirm({
        title:'Treasury Withdraw',
        html:`<div class="text-sm text-white/80">Withdraw <span class="mono">${amt}</span> wei to <span class="mono">${to}</span>?</div>`,
        note:'Admin-only. Emits events for monitoring.'
      }, async ()=>{
        try{
          await Core.ensureProvider(); await Core.ensureContract();
          const { signer, contract } = Core.get();
          const tx = await contract.connect(signer).treasuryWithdraw(to, BigInt(amt));
          Core.log(`Treasury withdraw: ${tx.hash}`);
          await tx.wait(); Core.log('Withdraw confirmed ✅','success');
        }catch(e){ Core.log(e.shortMessage||e.message||String(e),'error'); }
      });
    });

    el.bal.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { contract } = Core.get();
        let v='n/a'; try { v = (await contract.treasuryBalance()).toString(); } catch { v='(treasuryBalance view missing)'; }
        el.out.textContent = `treasuryBalance: ${v}`;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    el.dep.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { contract } = Core.get();
        let d='n/a'; try { d = await contract.deployerAddress(); } catch { d='(deployerAddress view missing)'; }
        el.out.textContent = `deployerAddress: ${d}`;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    el.paused.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract();
        const { contract } = Core.get();
        let p='n/a'; try { p = await contract.paused(); } catch { p='(paused() view missing)'; }
        el.out.textContent = `paused: ${p}`;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    return {};
  })();

  // =============== Views Module ===============
  const Views = (() => {
    const el = { stats: Core.$('vwStats'), cols: Core.$('vwCollections'), blue: Core.$('vwBluechips'), out: Core.$('vwOut') };

    el.stats.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract(); const { contract } = Core.get();
        let s='n/a'; try { s = await contract.stakingStats(); } catch { s='(stakingStats view missing)'; }
        el.out.textContent = typeof s === 'string' ? s : JSON.stringify(s, null, 2);
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    el.cols.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract(); const { contract } = Core.get();
        let c='n/a';
        try {
          const n = await contract.collectionCount?.();
          if (n !== undefined) c = `collectionCount: ${n.toString()}`;
          else c = '(collectionCount view missing)';
        } catch { c = '(collectionCount view missing)'; }
        el.out.textContent = c;
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    el.blue.addEventListener('click', async ()=>{
      try{
        await Core.ensureProvider(); await Core.ensureContract(); const { contract } = Core.get();
        let b='n/a';
        try { b = await contract.listBluechips?.() ?? '(listBluechips view missing)'; }
        catch { b = '(listBluechips view missing)'; }
        el.out.textContent = typeof b === 'string' ? b : JSON.stringify(b, null, 2);
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    return {};
  })();

  // =============== Global wiring ===============
  (function init(){
    const $ = Core.$;
    $('#year').textContent = new Date().getFullYear();

    // Tabs
    const buttons = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.panel');
    const activate = (key)=>{
      panels.forEach(p=>p.classList.add('hidden'));
      buttons.forEach(b=>b.classList.remove('tab-active'));
      document.getElementById('panel-'+key).classList.remove('hidden');
      document.querySelector(`[data-tab="${key}"]`).classList.add('tab-active');
    };
    buttons.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));
    activate('bluechip'); // default

    // Wallet & contract
    document.getElementById('connectBtn').addEventListener('click', async ()=>{
      try{ await Core.connectWallet(); await Core.cataBalance(); }catch(e){ Core.log(e.message||String(e),'error'); }
    });
    document.getElementById('saveContractBtn').addEventListener('click', async ()=>{
      try{
        const addr = document.getElementById('contractAddress').value.trim();
        await Core.setContract(addr);
        await Core.cataBalance();
      }catch(e){ Core.log(e.message||String(e),'error'); }
    });

    document.getElementById('logClear').addEventListener('click', ()=> Core.$('log').innerHTML='');
    Core.loadSavedContract();

    // preload network name if wallet present
    if (window.ethereum) {
      (async ()=>{
        try{
          await Core.ensureProvider();
          const net = await Core.get().provider.getNetwork();
          Core.state.chainId = Number(net.chainId);
          Core.state.networkName = net.name || `chain ${Core.state.chainId}`;
          document.getElementById('networkName').textContent = Core.state.networkName;
          document.getElementById('chainId').textContent = String(Core.state.chainId);
        }catch{}
      })();
    } else {
      document.getElementById('networkName').textContent = 'No wallet';
    }
  })();
  </script>
</body>
</html>
