<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Catalyst ‚Äî Official DApp</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <link rel="icon" href="data:," />
  <style>
    :root {
      --card: #0b1220;
      --ink: #e9eef7;
      --muted: #97a3b6;
      --line: #1b2640;
      --accent: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
    }
    html,
    body {
      background: #050b18;
      color: var(--ink);
    }
    .glass {
      background: rgba(12, 18, 34, 0.75);
      backdrop-filter: blur(10px);
    }
    .ring-1 {
      border: 1px solid var(--line);
    }
    .muted {
      color: var(--muted);
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", monospace;
    }
    .btn {
      border: 1px solid var(--line);
      padding: 0.6rem 0.8rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease-in-out;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-block {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .btn-ghost {
      border-color: transparent;
      padding: 0.6rem 0.8rem;
    }
    .btn-ghost.tab-active {
      background: var(--line);
      border-color: var(--line);
    }
    .btn-ghost:hover {
      border-color: var(--line);
      background: var(--line);
    }
    .btn-accent {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-accent:hover {
      background: #76b5fa;
      border-color: #76b5fa;
    }
    .btn-danger {
      background: var(--err);
      border-color: var(--err);
      color: white;
    }
    .btn-danger:hover {
      background: #f15e5e;
      border-color: #f15e5e;
    }
    .btn-ok {
      background: var(--ok);
      border-color: var(--ok);
      color: white;
    }
    .btn-ok:hover {
      background: #36cf6e;
      border-color: #36cf6e;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 0.5rem;
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      width: 100%;
      box-sizing: border-box;
      color: var(--ink);
    }
    input::placeholder {
      color: var(--muted);
    }
    .pill {
      display: inline-flex;
      background: var(--line);
      padding: 0.2rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    #log {
      height: 520px;
    }
    #log .logline {
      padding: 0.25rem 0.5rem;
      border-bottom: 1px solid #1a2d50;
      white-space: pre-wrap;
    }
    #log .logline:last-child {
      border-bottom: none;
    }
    #log .ok {
      color: var(--ok);
    }
    #log .warn {
      color: var(--warn);
    }
    #log .err {
      color: var(--err);
    }
    #modal {
      animation: fadeIn 0.15s ease-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body class="flex flex-col min-h-screen">
  <header class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex items-center gap-4">
      <img
        src="https://images.mirror-media.xyz/publication-images/q3g6p-yX1gL01P7l6jQ5W.png?height=2000&width=2000"
        class="w-12 h-12 rounded-full"
      />
      <h1 class="text-3xl font-bold">Catalyst</h1>
    </div>
    <div
      class="text-sm rounded-xl px-4 py-3 mt-4 ring-1 flex flex-wrap gap-2 items-center justify-between"
    >
      <div id="status" class="flex items-center gap-2">
        <div id="network-dot" class="w-2 h-2 rounded-full bg-slate-500"></div>
        <div class="text-sm muted">Disconnected</div>
      </div>
      <div class="flex flex-wrap gap-2">
        <div id="contract-addr" class="text-sm mono muted"></div>
        <button id="btnConnect" class="btn btn-ghost btn-sm">
          Connect Wallet
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 grow w-full grid md:grid-cols-3 gap-6">
    <section class="space-y-6 md:col-span-2">
      <div class="glass ring-1 rounded-2xl p-2 flex flex-wrap gap-2">
        <button data-tab="overview" class="tabbtn btn btn-ghost tab-active">
          Overview
        </button>
        <button data-tab="read" class="tabbtn btn btn-ghost">Read</button>
        <button data-tab="stake" class="tabbtn btn btn-ghost">Stake</button>
        <button data-tab="bluechip" class="tabbtn btn btn-ghost">
          Blue-Chip
        </button>
        <button data-tab="governance" class="tabbtn btn btn-ghost">
          Governance
        </button>
        <button data-tab="guardians" class="tabbtn btn btn-ghost">
          Guardians
        </button>
        <button data-tab="admin" class="tabbtn btn btn-ghost">Admin</button>
        <button data-tab="whitepaper" class="tabbtn btn btn-ghost">
          Whitepaper
        </button>
      </div>

      <div id="tab-overview" class="glass ring-1 rounded-2xl p-5 space-y-5">
        <div class="flex items-start gap-4">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üß≠
          </div>
          <div class="space-y-2">
            <h2 class="text-xl font-semibold title">Catalyst at a Glance</h2>
            <p class="muted leading-relaxed">
              Catalyst is a universal NFT staking protocol that enables any NFT
              collection to generate yield for its holders. Collections can be
              registered for a small fee, and once registered, holders can stake
              their NFTs to earn a share of the protocol's rewards. [cite: 3]
            </p>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Total NFTs Staked</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="stat-total-staked">...</span>
            </div>
            <div class="text-sm muted mt-2">
              <span id="stat-perm-staked">...</span> permanent,
              <span id="stat-term-staked">...</span> term
            </div>
          </div>
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Rewards per Block</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="stat-reward-rate">...</span>
              <span class="muted text-base mono">CAT</span>
            </div>
            <div class="text-sm muted mt-2">
              Base rate: <span id="stat-base-rate">...</span>
            </div>
          </div>
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Registered Collections</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="stat-collections">...</span>
            </div>
            <div class="text-sm muted mt-2">
              <span id="stat-bluechips">...</span> are blue-chips
            </div>
          </div>
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Your Total Staked NFTs</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="stat-your-staked">...</span>
            </div>
            <div class="text-sm muted mt-2">
              Term: <span id="stat-your-term">...</span>, Perm:
              <span id="stat-your-perm">...</span>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-read" class="glass ring-1 rounded-2xl p-5 space-y-5 hidden">
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üìñ
          </div>
          Read-Only Calls
        </h2>
        <p class="muted">
          Read data from the contract without sending a transaction.
        </p>

        <div class="flex flex-col sm:flex-row gap-4">
          <input
            id="collection-to-view"
            type="text"
            placeholder="Collection Address (optional)"
          />
          <button id="btnRefreshStats" class="btn btn-block btn-accent">
            Get Protocol Stats
          </button>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Collection Status</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="collection-status">...</span>
            </div>
          </div>
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Total Staked in Collection</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="collection-staked">...</span>
            </div>
          </div>
          <div class="glass ring-1 rounded-2xl p-4">
            <div class="text-xs muted mb-1">Your Rewards in Collection</div>
            <div class="text-3xl font-bold flex gap-2 items-center">
              <span id="collection-rewards">...</span>
              <span class="muted text-base mono">CAT</span>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-stake" class="glass ring-1 rounded-2xl p-5 space-y-5 hidden">
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üíé
          </div>
          Stake NFTs
        </h2>
        <p class="muted">
          Deposit NFTs from a collection to earn rewards. You must approve the
          contract first.
        </p>
        <input
          id="collection-to-stake"
          type="text"
          placeholder="Collection Address"
        />
        <input
          id="tokenids-to-stake"
          type="text"
          placeholder="Token IDs (e.g., 1,2,3 or 1-10)"
        />
        <div class="flex gap-2 items-center justify-between">
          <div class="flex items-center gap-2">
            <input id="is-permanent" type="checkbox" />
            <label for="is-permanent" class="text-sm muted">Permanent Stake</label>
          </div>
          <button id="btnApprove" class="btn btn-ghost btn-sm">
            Approve All
          </button>
        </div>
        <button id="btnStake" class="btn btn-block btn-accent">Stake</button>
      </div>

      <div
        id="tab-bluechip"
        class="glass ring-1 rounded-2xl p-5 space-y-5 hidden"
      >
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üìà
          </div>
          Blue-Chip Staking
        </h2>
        <p class="muted">
          Blue-chip collections receive a multiplier on their rewards. You can
          enroll your wallet to participate.
        </p>

        <div class="flex flex-col sm:flex-row gap-4">
          <input
            id="collection-to-bluechip"
            type="text"
            placeholder="Collection Address"
          />
          <button id="btnEnroll" class="btn btn-block btn-accent">
            Enroll
          </button>
        </div>
      </div>

      <div
        id="tab-governance"
        class="glass ring-1 rounded-2xl p-5 space-y-5 hidden"
      >
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üèõÔ∏è
          </div>
          Governance
        </h2>
        <p class="muted">
          Participate in proposals by staking NFTs. Proposals can adjust fees,
          reward rates, and collection tiers.
        </p>
        <div class="glass ring-1 rounded-2xl p-4">
          <div class="space-y-3">
            <h3 class="font-semibold">View Proposal Info (New)</h3>
            <input
              id="proposal-id"
              type="text"
              placeholder="Proposal ID (bytes32)"
            />
            <button id="btnGetProposalInfo" class="btn btn-block btn-accent">
              Get Proposal Info
            </button>
            <div id="proposal-info-display" class="mono text-xs mt-2 p-2 rounded-lg border border-[#122041] bg-[#081126] hidden"></div>
          </div>
        </div>
        <div class="glass ring-1 rounded-2xl p-4">
          <h3 class="font-semibold">Create Proposal</h3>
          <p class="muted text-sm mt-1">
            Propose a change to the protocol's parameters.
          </p>
          <div class="mt-3 space-y-3">
            <select id="proposal-type" class="w-full">
              <option value="0">Base Reward Rate</option>
              <option value="1">Harvest Fee</option>
              <option value="2">Unstake Fee</option>
              <option value="3">Registration Fee</option>
            </select>
            <input id="proposal-value" type="text" placeholder="New Value" />
            <input
              id="proposal-collection"
              type="text"
              placeholder="Collection Address (optional)"
            />
            <button id="btnCreateProposal" class="btn btn-block btn-accent">
              Create Proposal
            </button>
          </div>
        </div>
      </div>

      <div
        id="tab-guardians"
        class="glass ring-1 rounded-2xl p-5 space-y-5 hidden"
      >
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üõ°Ô∏è
          </div>
          Guardians
        </h2>
        <p class="muted">
          Guardian councils provide an added layer of security for key protocol
          functions, such as contract upgrades and treasury management.
        </p>

        <details class="rounded-lg ring-1 p-3">
          <summary class="cursor-pointer font-medium">Guardian Recovery (DRS)</summary>
          <p class="muted text-sm mt-2">
            Deployer and Admin councils (7 seats, 5-of-7 approvals by default). Recovery proposals allow safe rotation of keys and roles.
          </p>
        </details>
        <div class="text-xs muted">Read the full paper for math, proofs, and edge cases.</div>
      </div>
      
      <div id="tab-admin" class="glass ring-1 rounded-2xl p-5 space-y-5 hidden">
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            ‚öôÔ∏è
          </div>
          Admin Tools
        </h2>
        <p class="muted">
          Administrative tools for contract management (requires admin role).
        </p>
        <div class="glass ring-1 rounded-2xl p-4">
          <h3 class="font-semibold">Pause/Unpause</h3>
          <p class="muted text-sm mt-1">
            Temporarily pause the contract in case of an emergency.
          </p>
          <div class="mt-3 flex gap-2">
            <button id="btnPause" class="btn btn-block btn-danger">Pause</button>
            <button id="btnUnpause" class="btn btn-block btn-ok">Unpause</button>
          </div>
        </div>
        <div class="glass ring-1 rounded-2xl p-4">
          <h3 class="font-semibold">Treasury Management</h3>
          <p class="muted text-sm mt-1">
            Withdraw funds from the protocol treasury.
          </p>
          <div class="mt-3 space-y-3">
            <input id="toTreasury" type="text" placeholder="Recipient Address" />
            <input
              id="amtTreasury"
              type="text"
              placeholder="Amount (in wei)"
            />
            <button id="btnWithdraw" class="btn btn-block btn-accent">
              Withdraw
            </button>
          </div>
        </div>
      </div>
      
      <div
        id="tab-whitepaper"
        class="glass ring-1 rounded-2xl p-5 space-y-5 hidden"
      >
        <h2 class="text-xl font-semibold title flex items-center gap-3">
          <div
            class="hidden sm:block w-14 h-14 rounded-xl bg-[#0d162a] border border-[#1a2d50] grid place-items-center text-2xl"
          >
            üìù
          </div>
          Whitepaper
        </h2>
        <p class="muted">
          Read the full technical whitepaper for Catalyst Protocol.
        </p>
        <div class="glass ring-1 rounded-2xl p-4">
          <p class="muted text-sm leading-relaxed">
            The whitepaper outlines the technical architecture, tokenomics, and
            governance mechanisms of the Catalyst Protocol. It provides a
            comprehensive overview of the smart contract logic, the staking
            mechanism, and the roles of guardians and proposals.
          </p>
          <p class="muted text-sm leading-relaxed mt-2">
            You can find the full whitepaper on the official website or on a
            decentralized storage network like IPFS.
          </p>
        </div>
      </div>
    </section>

    <aside class="space-y-6 md:col-span-1">
      <div class="glass ring-1 rounded-2xl p-5">
        <h3 class="font-semibold mb-3">Console / Activity</h3>
        <div
          id="log"
          class="mono text-xs max-h-[520px] overflow-auto rounded-lg border border-[#122041] bg-[#081126] p-2"
        ></div>
        <div class="text-[11px] muted mt-2">
          Tips: You can use the <span class="kbd">Read</span> tab to explore
          safely. Write actions require wallet and may trigger confirmations.
        </div>
      </div>

      <div class="glass ring-1 rounded-2xl p-5">
        <h3 class="font-semibold mb-3">Safety Notes</h3>
        <ul class="text-sm muted space-y-2">
          <li>
            <span class="pill">Production</span> Always verify you‚Äôre on the official domain & contract.
          </li>
          <li>
            <span class="pill">Fees</span> The 90/9/1 split is immutable by design.
          </li>
          <li>
            <span class="pill">Upgrades</span> Contract may be upgradable; review proxy admin ownership and change logs.
          </li>
        </ul>
      </div>
    </aside>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-center muted text-sm">
    Catalyst ‚Ä¢ Universal NFT Utility ‚Ä¢ ¬© <span id="year"></span>
  </footer>

  <div
    id="modal"
    class="fixed inset-0 hidden items-center justify-center z-50"
  >
    <div class="absolute inset-0 bg-black/60"></div>
    <div
      class="relative glass ring-1 rounded-2xl w-[95%] max-w-lg p-5 space-y-4"
    >
      <div class="flex items-start gap-3">
        <div
          id="modalIcon"
          class="w-10 h-10 rounded-lg grid place-items-center text-xl"
        >
          ‚ö†Ô∏è
        </div>
        <div class="grow">
          <h3 id="modalTitle" class="font-semibold">Confirm</h3>
          <p id="modalBody" class="muted text-sm mt-1">Are you sure?</p>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button id="modalCancel" class="btn btn-ghost">Cancel</button>
        <button id="modalConfirm" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       CONFIG & STATE
       ========================= */
    const DEFAULT_CONTRACT = "0xd2a5bC10698FD955D1Fe6cb468a17809A08fd005"; // ‚Üê set your official proxy here (optional)
    const DEFAULT_RPC = "https://rpc.test.btcs.network/"; // ‚Üê optional default read RPC

    const ABI = [
      "function getProtocolStats(address collection, address wallet) view returns (uint256 totalStakedAll, uint256 totalStakedTerm, uint256 totalStakedPermanent, uint256 baseRewardRate, uint256 numberOfCollections, uint256 numberOfBluechips, uint256 yourStakedCount, uint256 yourTermStaked, uint256 yourPermStaked, uint256 collectionTotalStaked, bool isRegistered, uint8 collectionTier, uint256 yourPendingRewards)",
      "function getProposalInfo(bytes32 id) view returns (uint8 pType, uint8 paramTarget, uint256 newValue, address collectionAddress, address proposer, uint256 startBlock, uint256 endBlock, uint256 votesScaled, bool executed)",
      "function stake(address collection, uint256[] calldata tokenIds, bool isPermanent) payable",
      "function unstake(address collection, uint256[] calldata tokenIds)",
      "function harvest(address collection, uint256[] calldata tokenIds)",
      "function registerCollection(address collection, uint256 declaredSupply) payable",
      "function setBluechip(address collection, bool isBluechip)",
      "function enrollBluechip(address collection)",
      "function createProposal(uint8 pType, uint256 newValue, address collection)",
      "function vote(bytes32 id, address collection)",
      "function executeProposal(bytes32 id)",
      "function pause()",
      "function unpause()",
      "function withdrawTreasury(address to, uint256 amount)",
      "event CollectionTierUpgraded(address indexed collection, uint8 newTier)",
      "event BluechipCollectionSet(address indexed collection, bool isBluechip)",
      "event CollectionAdded(address indexed collection, uint256 declaredSupply, uint256 paid)",
      "event NFTStaked(address indexed owner, address indexed collection, uint256 indexed tokenId, bool permanent)",
      "event NFTUnstaked(address indexed owner, address indexed collection, uint256 indexed tokenId)",
      "event RewardsHarvested(address indexed owner, address indexed collection, uint256 gross, uint256 burned)",
      "event TreasuryDeposit(address indexed from, uint256 amount)",
      "event TreasuryWithdrawal(address indexed to, uint256 amount)",
      "event BaseRewardRateUpdated(uint256 oldValue, uint256 newValue)",
      "event HarvestFeeUpdated(uint256 oldValue, uint256 newValue)",
      "event UnstakeBurnFeeUpdated(uint256 oldValue, uint256 newValue)",
      "event CollectionRegistrationFeeUpdated(uint256 oldValue, uint256 newValue)",
      "event VotingDurationUpdated(uint256 oldValue, uint256 newValue)",
      "event MinVotesRequiredUpdated(uint256 oldValue, uint256 newValue)",
      "event CollectionVoteCapUpdated(uint256 oldValue, uint256 newValue)",
      "event ProposalCreated(bytes32 indexed id, uint8 pType, uint8 paramTarget, address indexed collection, address indexed proposer, uint256 newValue, uint256 startBlock, uint256 endBlock)",
      "event VoteCast(bytes32 indexed id, address indexed voter, uint256 weightScaled, address attributedCollection)",
      "event ProposalMarkedExecuted(bytes32 indexed id)",
      "event GuardianSet(bytes32 indexed councilId, uint8 indexed idx, address guardian)",
      "event RecoveryProposed(bytes32 indexed councilId, address indexed proposer, address proposed, uint256 deadline)",
      "event RecoveryApproved(bytes32 indexed councilId, address indexed guardian, uint8 approvals)",
      "event Recovered(bytes32 indexed councilId, address oldAddress, address newAddress)",
    ];

    const ERC721_ABI = [
      "function setApprovalForAll(address operator, bool approved)",
      "function isApprovedForAll(address owner, address operator) view returns (bool)",
      "function balanceOf(address owner) view returns (uint256)",
    ];

    let READ_PROVIDER = null;
    let WALLET_PROVIDER = null;
    let SIGNER = null;
    let USER_ADDR = null;

    let READ_CONTRACT = null;
    let WRITE_CONTRACT = null;
    let CONTRACT_ADDR = "";

    let refreshTimer = null;

    /* =========================
       DOM HELPERS & LOG
       ========================= */
    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => document.querySelectorAll(sel);
    function now() {
      return new Date().toLocaleTimeString();
    }
    function log(msg, cls = "") {
      const wrap = $("log");
      const div = document.createElement("div");
      div.className = "logline " + (cls || "");
      div.textContent = `[${now()}] ${msg}`;
      wrap.prepend(div);
      if (wrap.scrollHeight > wrap.clientHeight) {
        wrap.scrollTop = 0;
      }
    }
    function setYear() {
      $("year").textContent = new Date().getFullYear();
    }
    function formatAddress(addr) {
      return `${addr.substring(0, 6)}...${addr.substring(38)}`;
    }
    function formatEther(wei) {
      if (!wei) return "0";
      return ethers.formatEther(wei);
    }
    function formatNumber(num) {
      if (typeof num === "bigint") {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      return num.toLocaleString();
    }
    function parseAddress(s) {
      try {
        return ethers.getAddress(s);
      } catch (e) {
        throw new Error("Invalid address");
      }
    }
    function parseUint(s) {
      try {
        return BigInt(s);
      } catch (e) {
        throw new Error("Invalid number");
      }
    }
    function parseTokenIds(s) {
      const tokenIds = [];
      const parts = s.split(",");
      for (const part of parts) {
        const range = part.split("-");
        if (range.length === 1) {
          tokenIds.push(parseUint(range[0].trim()));
        } else if (range.length === 2) {
          const start = parseUint(range[0].trim());
          const end = parseUint(range[1].trim());
          if (start > end) throw new Error("Invalid range");
          for (let i = start; i <= end; i++) {
            tokenIds.push(i);
          }
        }
      }
      return tokenIds;
    }
    function showModal({ title, body, icon, danger = false }) {
      return new Promise((resolve) => {
        const modal = $("modal");
        $("modalTitle").textContent = title;
        $("modalBody").textContent = body;
        $("modalIcon").textContent = icon;
        $("modalConfirm").className = danger
          ? "btn btn-danger"
          : "btn btn-ok";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        $("modalConfirm").onclick = () => {
          modal.classList.remove("flex");
          modal.classList.add("hidden");
          resolve(true);
        };
        $("modalCancel").onclick = () => {
          modal.classList.remove("flex");
          modal.classList.add("hidden");
          resolve(false);
        };
      });
    }

    /* =========================
       CONNECTIVITY
       ========================= */
    function requireWallet() {
      if (!USER_ADDR) {
        log("Wallet not connected. Connect your wallet first.", "err");
        throw new Error("Wallet not connected");
      }
    }
    async function initReadContract() {
      if (!READ_PROVIDER) {
        READ_PROVIDER = new ethers.JsonRpcProvider(DEFAULT_RPC);
        READ_CONTRACT = new ethers.Contract(CONTRACT_ADDR, ABI, READ_PROVIDER);
      }
    }
    async function initWriteContract() {
      await requireWallet();
      WRITE_CONTRACT = new ethers.Contract(CONTRACT_ADDR, ABI, SIGNER);
    }
    async function connectWallet() {
      try {
        WALLET_PROVIDER = new ethers.BrowserProvider(window.ethereum);
        SIGNER = await WALLET_PROVIDER.getSigner();
        USER_ADDR = await SIGNER.getAddress();
        READ_PROVIDER = WALLET_PROVIDER; // use wallet provider for reads
        $("network-dot").className = "w-2 h-2 rounded-full bg-green-500";
        $("status").innerHTML = `
          <div class="w-2 h-2 rounded-full bg-green-500"></div>
          <div class="text-sm">Connected</div>
        `;
        $("btnConnect").textContent = formatAddress(USER_ADDR);
        log(`Wallet connected: ${USER_ADDR}`);
        initContracts();
        startAutoRefresh();
      } catch (e) {
        log(e.message || e, "err");
      }
    }
    function initContracts() {
      CONTRACT_ADDR = $("contract-addr").textContent || DEFAULT_CONTRACT;
      $("contract-addr").textContent = formatAddress(CONTRACT_ADDR);
      READ_CONTRACT = new ethers.Contract(CONTRACT_ADDR, ABI, READ_PROVIDER);
      if (USER_ADDR) {
        WRITE_CONTRACT = new ethers.Contract(CONTRACT_ADDR, ABI, SIGNER);
      }
    }
    async function refreshAll() {
      log("Refreshing stats...", "warn");
      try {
        await refreshStats();
        log("Stats refreshed ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    }
    async function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(refreshAll, 15000);
      await refreshAll();
    }
    async function handleDisconnect() {
      if (typeof window.ethereum !== "undefined") {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            log("Wallet disconnected", "warn");
            USER_ADDR = null;
            SIGNER = null;
            WALLET_PROVIDER = null;
            $("network-dot").className = "w-2 h-2 rounded-full bg-slate-500";
            $("status").innerHTML = `
              <div class="w-2 h-2 rounded-full bg-slate-500"></div>
              <div class="text-sm muted">Disconnected</div>
            `;
            $("btnConnect").textContent = "Connect Wallet";
            if (refreshTimer) clearInterval(refreshTimer);
            initReadContract(); // Switch back to read-only provider
          }
        });
      }
    }

    /* =========================
       CONTRACT INTERACTIONS
       ========================= */
    async function refreshStats(collection = ethers.ZeroAddress) {
      let wallet = USER_ADDR || ethers.ZeroAddress;
      if (collection.trim() === '') {
        collection = ethers.ZeroAddress;
      }
      try {
        await initReadContract();
        const stats = await READ_CONTRACT.getProtocolStats(collection, wallet);
        
        // Update Overview tab
        $("stat-total-staked").textContent = formatNumber(stats.totalStakedAll);
        $("stat-perm-staked").textContent = formatNumber(stats.totalStakedPermanent);
        $("stat-term-staked").textContent = formatNumber(stats.totalStakedTerm);
        $("stat-reward-rate").textContent = formatEther(stats.baseRewardRate);
        $("stat-base-rate").textContent = formatEther(stats.baseRewardRate);
        $("stat-collections").textContent = formatNumber(stats.numberOfCollections);
        $("stat-bluechips").textContent = formatNumber(stats.numberOfBluechips);
        
        if (USER_ADDR) {
          $("stat-your-staked").textContent = formatNumber(stats.yourStakedCount);
          $("stat-your-term").textContent = formatNumber(stats.yourTermStaked);
          $("stat-your-perm").textContent = formatNumber(stats.yourPermStaked);
        }

        // Update Read tab
        let collectionStatusText = "Not Registered";
        if (stats.isRegistered) {
            if (stats.collectionTier == 3) {
                collectionStatusText = "Blue-chip";
            } else {
                collectionStatusText = "Verified";
            }
        }
        $("collection-status").textContent = collectionStatusText;
        $("collection-staked").textContent = formatNumber(stats.collectionTotalStaked);
        $("collection-rewards").textContent = formatEther(stats.yourPendingRewards);

      } catch (e) {
        log(e.message || e, "err");
      }
    }

    async function getProposalInfo() {
      try {
        const id = $("proposal-id").value;
        if (!id) throw new Error("Please enter a Proposal ID.");
        
        await initReadContract();
        const proposal = await READ_CONTRACT.getProposalInfo(id);

        const proposalInfoDisplay = $("proposal-info-display");
        proposalInfoDisplay.classList.remove("hidden");
        
        let pType = "";
        switch (proposal.pType) {
            case 0: pType = "BASE_REWARD"; break;
            case 1: pType = "HARVEST_FEE"; break;
            case 2: pType = "UNSTAKE_FEE"; break;
            case 3: pType = "REGISTRATION_FEE_FALLBACK"; break;
            case 4: pType = "VOTING_PARAM"; break;
            case 5: pType = "TIER_UPGRADE"; break;
        }

        proposalInfoDisplay.innerHTML = `
          <strong>Proposal ID:</strong> ${id}<br>
          <strong>Type:</strong> ${pType}<br>
          <strong>New Value:</strong> ${formatNumber(proposal.newValue)}<br>
          <strong>Collection:</strong> ${proposal.collectionAddress}<br>
          <strong>Proposer:</strong> ${proposal.proposer}<br>
          <strong>Start Block:</strong> ${formatNumber(proposal.startBlock)}<br>
          <strong>End Block:</strong> ${formatNumber(proposal.endBlock)}<br>
          <strong>Votes:</strong> ${formatNumber(proposal.votesScaled)}<br>
          <strong>Executed:</strong> ${proposal.executed ? "‚úÖ Yes" : "‚ùå No"}
        `;
        
        log(`Proposal ${id} info fetched.`, "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    }

    /* =========================
       DOM LISTENERS
       ========================= */
    window.addEventListener("DOMContentLoaded", () => {
      setYear();
      initReadContract();
      handleDisconnect();
    });

    $("btnConnect").onclick = connectWallet;

    $$(".tabbtn").forEach((btn) => {
      btn.onclick = (e) => {
        const tab = e.target.dataset.tab;
        $$(".tabbtn").forEach((b) => b.classList.remove("tab-active"));
        e.target.classList.add("tab-active");
        $$("[id^='tab-']").forEach((t) => t.classList.add("hidden"));
        $(`tab-${tab}`).classList.remove("hidden");
        // refresh stats on tab change
        if (tab === "overview" || tab === "read") {
          refreshAll();
        }
      };
    });

    $("btnRefreshStats").onclick = () => {
      const collection = $("collection-to-view").value;
      refreshStats(collection);
    };

    $("btnGetProposalInfo").onclick = getProposalInfo;

    // Stake
    $("btnApprove").onclick = async () => {
      try {
        requireWallet();
        const collection = parseAddress($("collection-to-stake").value);
        const ok = await showModal({
          title: "Approve Contract",
          body: `This will approve the contract to manage all NFTs in the collection: ${formatAddress(collection)}`,
          icon: "‚úçÔ∏è",
          danger: false,
        });
        if (!ok) {
          log("Approval cancelled", "warn");
          return;
        }
        const erc721 = new ethers.Contract(collection, ERC721_ABI, SIGNER);
        const tx = await erc721.setApprovalForAll(CONTRACT_ADDR, true);
        log(`Approval sent: ${tx.hash}`);
        await tx.wait();
        log("Approval confirmed ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    $("btnStake").onclick = async () => {
      try {
        requireWallet();
        const collection = parseAddress($("collection-to-stake").value);
        const tokenIds = parseTokenIds($("tokenids-to-stake").value);
        const isPermanent = $("is-permanent").checked;
        const ok = await showModal({
          title: "Stake NFTs",
          body: `This will stake ${tokenIds.length} NFTs from ${formatAddress(collection)}. Are you sure?`,
          icon: "üíé",
          danger: false,
        });
        if (!ok) {
          log("Stake cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.stake(collection, tokenIds, isPermanent);
        log(`Stake sent: ${tx.hash}`);
        await tx.wait();
        log("Stake confirmed ‚úÖ", "ok");
        refreshAll();
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    // Blue-Chip
    $("btnEnroll").onclick = async () => {
      try {
        requireWallet();
        const collection = parseAddress($("collection-to-bluechip").value);
        const ok = await showModal({
          title: "Enroll in Blue-Chip",
          body: `This will enroll your wallet for blue-chip staking in the collection: ${formatAddress(collection)}. Are you sure?`,
          icon: "üìà",
          danger: false,
        });
        if (!ok) {
          log("Enrollment cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.enrollBluechip(collection);
        log(`Enrollment sent: ${tx.hash}`);
        await tx.wait();
        log("Enrollment confirmed ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    // Governance
    $("btnCreateProposal").onclick = async () => {
      try {
        requireWallet();
        const pType = parseInt($("proposal-type").value);
        const newValue = parseUint($("proposal-value").value);
        const collection = parseAddress($("proposal-collection").value);
        const ok = await showModal({
          title: "Create Proposal",
          body: `This will create a new governance proposal. Are you sure?`,
          icon: "üèõÔ∏è",
          danger: false,
        });
        if (!ok) {
          log("Proposal creation cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.createProposal(
          pType,
          newValue,
          collection
        );
        log(`Proposal creation sent: ${tx.hash}`);
        await tx.wait();
        log("Proposal created ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    // Admin
    $("btnPause").onclick = async () => {
      try {
        requireWallet();
        const ok = await showModal({
          title: "Pause Contract",
          body: "This will pause all user interactions with the contract. Only use in an emergency. Confirm?",
          icon: "‚ö†Ô∏è",
          danger: true,
        });
        if (!ok) {
          log("Pause cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.pause();
        log(`Pause sent: ${tx.hash}`);
        await tx.wait();
        log("Contract paused ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    $("btnUnpause").onclick = async () => {
      try {
        requireWallet();
        const ok = await showModal({
          title: "Unpause Contract",
          body: "This will unpause the contract and re-enable user interactions. Confirm?",
          icon: "‚úÖ",
          danger: false,
        });
        if (!ok) {
          log("Unpause cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.unpause();
        log(`Unpause sent: ${tx.hash}`);
        await tx.wait();
        log("Contract unpaused ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };

    $("btnWithdraw").onclick = async () => {
      try {
        requireWallet();
        const to = parseAddress($("toTreasury").value);
        const amt = parseUint($("amtTreasury").value);
        const ok = await showModal({
          title: "Withdraw from Treasury",
          body: `This will transfer ${formatEther(amt)} ETH to:\n${formatAddress(to)}\n\nConfirm?`,
          icon: "üè¶",
          danger: true,
        });
        if (!ok) {
          log("Withdraw cancelled", "warn");
          return;
        }
        await initWriteContract();
        const tx = await WRITE_CONTRACT.withdrawTreasury(to, amt);
        log(`Withdraw sent: ${tx.hash}`);
        await tx.wait();
        log("Withdraw confirmed ‚úÖ", "ok");
      } catch (e) {
        log(e.message || e, "err");
      }
    };
  </script>
</body>
</html>
